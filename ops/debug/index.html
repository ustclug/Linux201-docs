
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Linux 201 进阶教程">
      
      
        <meta name="author" content="LUG @ USTC">
      
      
        <link rel="canonical" href="https://201.ustclug.org/ops/debug/">
      
      
        <link rel="prev" href="../database/kv/">
      
      
        <link rel="next" href="../virtualization/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>问题调试 - Linux 201</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-160637954-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-160637954-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-160637954-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Linux 201" class="md-header__button md-logo" aria-label="Linux 201" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M220.9 123.3c1 .5 1.8 1.7 3 1.7 1.1 0 2.8-.4 2.9-1.5.2-1.4-1.9-2.3-3.2-2.9-1.7-.7-3.9-1-5.5-.1-.4.2-.8.7-.6 1.1.3 1.3 2.3 1.1 3.4 1.7M199 125c1.2 0 2-1.2 3-1.7 1.1-.6 3.1-.4 3.5-1.6.2-.4-.2-.9-.6-1.1-1.6-.9-3.8-.6-5.5.1-1.3.6-3.4 1.5-3.2 2.9.1 1 1.8 1.5 2.8 1.4m221 278.8c-3.6-4-5.3-11.6-7.2-19.7-1.8-8.1-3.9-16.8-10.5-22.4-1.3-1.1-2.6-2.1-4-2.9-1.3-.8-2.7-1.5-4.1-2 9.2-27.3 5.6-54.5-3.7-79.1-11.4-30.1-31.3-56.4-46.5-74.4-17.1-21.5-33.7-41.9-33.4-72C311.1 85.4 315.7.1 234.8 0 132.4-.2 158 103.4 156.9 135.2c-1.7 23.4-6.4 41.8-22.5 64.7-18.9 22.5-45.5 58.8-58.1 96.7-6 17.9-8.8 36.1-6.2 53.3-6.5 5.8-11.4 14.7-16.6 20.2-4.2 4.3-10.3 5.9-17 8.3s-14 6-18.5 14.5c-2.1 3.9-2.8 8.1-2.8 12.4 0 3.9.6 7.9 1.2 11.8 1.2 8.1 2.5 15.7.8 20.8-5.2 14.4-5.9 24.4-2.2 31.7 3.8 7.3 11.4 10.5 20.1 12.3 17.3 3.6 40.8 2.7 59.3 12.5 19.8 10.4 39.9 14.1 55.9 10.4 11.6-2.6 21.1-9.6 25.9-20.2 12.5-.1 26.3-5.4 48.3-6.6 14.9-1.2 33.6 5.3 55.1 4.1.6 2.3 1.4 4.6 2.5 6.7v.1c8.3 16.7 23.8 24.3 40.3 23 16.6-1.3 34.1-11 48.3-27.9 13.6-16.4 36-23.2 50.9-32.2 7.4-4.5 13.4-10.1 13.9-18.3.4-8.2-4.4-17.3-15.5-29.7M223.8 87.3c9.8-22.2 34.2-21.8 44-.4 6.5 14.2 3.6 30.9-4.3 40.4-1.6-.8-5.9-2.6-12.6-4.9 1.1-1.2 3.1-2.7 3.9-4.6 4.8-11.8-.2-27-9.1-27.3-7.3-.5-13.9 10.8-11.8 23-4.1-2-9.4-3.5-13-4.4-1-6.9-.3-14.6 2.9-21.8m-40.7-11.5c10.1 0 20.8 14.2 19.1 33.5-3.5 1-7.1 2.5-10.2 4.6 1.2-8.9-3.3-20.1-9.6-19.6-8.4.7-9.8 21.2-1.8 28.1 1 .8 1.9-.2-5.9 5.5-15.6-14.6-10.5-52.1 8.4-52.1m-13.6 60.7c6.2-4.6 13.6-10 14.1-10.5 4.7-4.4 13.5-14.2 27.9-14.2 7.1 0 15.6 2.3 25.9 8.9 6.3 4.1 11.3 4.4 22.6 9.3 8.4 3.5 13.7 9.7 10.5 18.2-2.6 7.1-11 14.4-22.7 18.1-11.1 3.6-19.8 16-38.2 14.9-3.9-.2-7-1-9.6-2.1-8-3.5-12.2-10.4-20-15-8.6-4.8-13.2-10.4-14.7-15.3q-2.1-7.35 4.2-12.3m3.3 334c-2.7 35.1-43.9 34.4-75.3 18-29.9-15.8-68.6-6.5-76.5-21.9-2.4-4.7-2.4-12.7 2.6-26.4v-.2c2.4-7.6.6-16-.6-23.9-1.2-7.8-1.8-15 .9-20 3.5-6.7 8.5-9.1 14.8-11.3 10.3-3.7 11.8-3.4 19.6-9.9 5.5-5.7 9.5-12.9 14.3-18 5.1-5.5 10-8.1 17.7-6.9 8.1 1.2 15.1 6.8 21.9 16l19.6 35.6c9.5 19.9 43.1 48.4 41 68.9m-1.4-25.9c-4.1-6.6-9.6-13.6-14.4-19.6 7.1 0 14.2-2.2 16.7-8.9 2.3-6.2 0-14.9-7.4-24.9-13.5-18.2-38.3-32.5-38.3-32.5-13.5-8.4-21.1-18.7-24.6-29.9s-3-23.3-.3-35.2c5.2-22.9 18.6-45.2 27.2-59.2 2.3-1.7.8 3.2-8.7 20.8-8.5 16.1-24.4 53.3-2.6 82.4.6-20.7 5.5-41.8 13.8-61.5 12-27.4 37.3-74.9 39.3-112.7 1.1.8 4.6 3.2 6.2 4.1 4.6 2.7 8.1 6.7 12.6 10.3 12.4 10 28.5 9.2 42.4 1.2 6.2-3.5 11.2-7.5 15.9-9 9.9-3.1 17.8-8.6 22.3-15 7.7 30.4 25.7 74.3 37.2 95.7 6.1 11.4 18.3 35.5 23.6 64.6 3.3-.1 7 .4 10.9 1.4 13.8-35.7-11.7-74.2-23.3-84.9-4.7-4.6-4.9-6.6-2.6-6.5 12.6 11.2 29.2 33.7 35.2 59 2.8 11.6 3.3 23.7.4 35.7 16.4 6.8 35.9 17.9 30.7 34.8-2.2-.1-3.2 0-4.2 0 3.2-10.1-3.9-17.6-22.8-26.1-19.6-8.6-36-8.6-38.3 12.5-12.1 4.2-18.3 14.7-21.4 27.3-2.8 11.2-3.6 24.7-4.4 39.9-.5 7.7-3.6 18-6.8 29-32.1 22.9-76.7 32.9-114.3 7.2m257.4-11.5c-.9 16.8-41.2 19.9-63.2 46.5-13.2 15.7-29.4 24.4-43.6 25.5s-26.5-4.8-33.7-19.3c-4.7-11.1-2.4-23.1 1.1-36.3 3.7-14.2 9.2-28.8 9.9-40.6.8-15.2 1.7-28.5 4.2-38.7 2.6-10.3 6.6-17.2 13.7-21.1.3-.2.7-.3 1-.5.8 13.2 7.3 26.6 18.8 29.5 12.6 3.3 30.7-7.5 38.4-16.3 9-.3 15.7-.9 22.6 5.1 9.9 8.5 7.1 30.3 17.1 41.6 10.6 11.6 14 19.5 13.7 24.6M173.4 148.7c2 1.9 4.7 4.5 8 7.1 6.6 5.2 15.8 10.6 27.3 10.6 11.6 0 22.5-5.9 31.8-10.8 4.9-2.6 10.9-7 14.8-10.4s5.9-6.3 3.1-6.6-2.6 2.6-6 5.1c-4.4 3.2-9.7 7.4-13.9 9.8-7.4 4.2-19.5 10.2-29.9 10.2s-18.7-4.8-24.9-9.7c-3.1-2.5-5.7-5-7.7-6.9-1.5-1.4-1.9-4.6-4.3-4.9-1.4-.1-1.8 3.7 1.7 6.5"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Linux 201
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              问题调试
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="切换至深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="purple" data-md-color-accent="purple"  aria-label="切换至浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ustclug/Linux201-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.01 8.01 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27s-1.36.09-2 .27c-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8"/></svg>
  </div>
  <div class="md-source__repository">
    ustclug/Linux201-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Linux 201" class="md-nav__button md-logo" aria-label="Linux 201" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M220.9 123.3c1 .5 1.8 1.7 3 1.7 1.1 0 2.8-.4 2.9-1.5.2-1.4-1.9-2.3-3.2-2.9-1.7-.7-3.9-1-5.5-.1-.4.2-.8.7-.6 1.1.3 1.3 2.3 1.1 3.4 1.7M199 125c1.2 0 2-1.2 3-1.7 1.1-.6 3.1-.4 3.5-1.6.2-.4-.2-.9-.6-1.1-1.6-.9-3.8-.6-5.5.1-1.3.6-3.4 1.5-3.2 2.9.1 1 1.8 1.5 2.8 1.4m221 278.8c-3.6-4-5.3-11.6-7.2-19.7-1.8-8.1-3.9-16.8-10.5-22.4-1.3-1.1-2.6-2.1-4-2.9-1.3-.8-2.7-1.5-4.1-2 9.2-27.3 5.6-54.5-3.7-79.1-11.4-30.1-31.3-56.4-46.5-74.4-17.1-21.5-33.7-41.9-33.4-72C311.1 85.4 315.7.1 234.8 0 132.4-.2 158 103.4 156.9 135.2c-1.7 23.4-6.4 41.8-22.5 64.7-18.9 22.5-45.5 58.8-58.1 96.7-6 17.9-8.8 36.1-6.2 53.3-6.5 5.8-11.4 14.7-16.6 20.2-4.2 4.3-10.3 5.9-17 8.3s-14 6-18.5 14.5c-2.1 3.9-2.8 8.1-2.8 12.4 0 3.9.6 7.9 1.2 11.8 1.2 8.1 2.5 15.7.8 20.8-5.2 14.4-5.9 24.4-2.2 31.7 3.8 7.3 11.4 10.5 20.1 12.3 17.3 3.6 40.8 2.7 59.3 12.5 19.8 10.4 39.9 14.1 55.9 10.4 11.6-2.6 21.1-9.6 25.9-20.2 12.5-.1 26.3-5.4 48.3-6.6 14.9-1.2 33.6 5.3 55.1 4.1.6 2.3 1.4 4.6 2.5 6.7v.1c8.3 16.7 23.8 24.3 40.3 23 16.6-1.3 34.1-11 48.3-27.9 13.6-16.4 36-23.2 50.9-32.2 7.4-4.5 13.4-10.1 13.9-18.3.4-8.2-4.4-17.3-15.5-29.7M223.8 87.3c9.8-22.2 34.2-21.8 44-.4 6.5 14.2 3.6 30.9-4.3 40.4-1.6-.8-5.9-2.6-12.6-4.9 1.1-1.2 3.1-2.7 3.9-4.6 4.8-11.8-.2-27-9.1-27.3-7.3-.5-13.9 10.8-11.8 23-4.1-2-9.4-3.5-13-4.4-1-6.9-.3-14.6 2.9-21.8m-40.7-11.5c10.1 0 20.8 14.2 19.1 33.5-3.5 1-7.1 2.5-10.2 4.6 1.2-8.9-3.3-20.1-9.6-19.6-8.4.7-9.8 21.2-1.8 28.1 1 .8 1.9-.2-5.9 5.5-15.6-14.6-10.5-52.1 8.4-52.1m-13.6 60.7c6.2-4.6 13.6-10 14.1-10.5 4.7-4.4 13.5-14.2 27.9-14.2 7.1 0 15.6 2.3 25.9 8.9 6.3 4.1 11.3 4.4 22.6 9.3 8.4 3.5 13.7 9.7 10.5 18.2-2.6 7.1-11 14.4-22.7 18.1-11.1 3.6-19.8 16-38.2 14.9-3.9-.2-7-1-9.6-2.1-8-3.5-12.2-10.4-20-15-8.6-4.8-13.2-10.4-14.7-15.3q-2.1-7.35 4.2-12.3m3.3 334c-2.7 35.1-43.9 34.4-75.3 18-29.9-15.8-68.6-6.5-76.5-21.9-2.4-4.7-2.4-12.7 2.6-26.4v-.2c2.4-7.6.6-16-.6-23.9-1.2-7.8-1.8-15 .9-20 3.5-6.7 8.5-9.1 14.8-11.3 10.3-3.7 11.8-3.4 19.6-9.9 5.5-5.7 9.5-12.9 14.3-18 5.1-5.5 10-8.1 17.7-6.9 8.1 1.2 15.1 6.8 21.9 16l19.6 35.6c9.5 19.9 43.1 48.4 41 68.9m-1.4-25.9c-4.1-6.6-9.6-13.6-14.4-19.6 7.1 0 14.2-2.2 16.7-8.9 2.3-6.2 0-14.9-7.4-24.9-13.5-18.2-38.3-32.5-38.3-32.5-13.5-8.4-21.1-18.7-24.6-29.9s-3-23.3-.3-35.2c5.2-22.9 18.6-45.2 27.2-59.2 2.3-1.7.8 3.2-8.7 20.8-8.5 16.1-24.4 53.3-2.6 82.4.6-20.7 5.5-41.8 13.8-61.5 12-27.4 37.3-74.9 39.3-112.7 1.1.8 4.6 3.2 6.2 4.1 4.6 2.7 8.1 6.7 12.6 10.3 12.4 10 28.5 9.2 42.4 1.2 6.2-3.5 11.2-7.5 15.9-9 9.9-3.1 17.8-8.6 22.3-15 7.7 30.4 25.7 74.3 37.2 95.7 6.1 11.4 18.3 35.5 23.6 64.6 3.3-.1 7 .4 10.9 1.4 13.8-35.7-11.7-74.2-23.3-84.9-4.7-4.6-4.9-6.6-2.6-6.5 12.6 11.2 29.2 33.7 35.2 59 2.8 11.6 3.3 23.7.4 35.7 16.4 6.8 35.9 17.9 30.7 34.8-2.2-.1-3.2 0-4.2 0 3.2-10.1-3.9-17.6-22.8-26.1-19.6-8.6-36-8.6-38.3 12.5-12.1 4.2-18.3 14.7-21.4 27.3-2.8 11.2-3.6 24.7-4.4 39.9-.5 7.7-3.6 18-6.8 29-32.1 22.9-76.7 32.9-114.3 7.2m257.4-11.5c-.9 16.8-41.2 19.9-63.2 46.5-13.2 15.7-29.4 24.4-43.6 25.5s-26.5-4.8-33.7-19.3c-4.7-11.1-2.4-23.1 1.1-36.3 3.7-14.2 9.2-28.8 9.9-40.6.8-15.2 1.7-28.5 4.2-38.7 2.6-10.3 6.6-17.2 13.7-21.1.3-.2.7-.3 1-.5.8 13.2 7.3 26.6 18.8 29.5 12.6 3.3 30.7-7.5 38.4-16.3 9-.3 15.7-.9 22.6 5.1 9.9 8.5 7.1 30.3 17.1 41.6 10.6 11.6 14 19.5 13.7 24.6M173.4 148.7c2 1.9 4.7 4.5 8 7.1 6.6 5.2 15.8 10.6 27.3 10.6 11.6 0 22.5-5.9 31.8-10.8 4.9-2.6 10.9-7 14.8-10.4s5.9-6.3 3.1-6.6-2.6 2.6-6 5.1c-4.4 3.2-9.7 7.4-13.9 9.8-7.4 4.2-19.5 10.2-29.9 10.2s-18.7-4.8-24.9-9.7c-3.1-2.5-5.7-5-7.7-6.9-1.5-1.4-1.9-4.6-4.3-4.9-1.4-.1-1.8 3.7 1.7 6.5"/></svg>

    </a>
    Linux 201
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ustclug/Linux201-docs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.01 8.01 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27s-1.36.09-2 .27c-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8"/></svg>
  </div>
  <div class="md-source__repository">
    ustclug/Linux201-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../preface/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 9h2V7h-2m1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-18A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2m-1 15h2v-6h-2z"/></svg>
  
  <span class="md-ellipsis">
    序言
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spec/writing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    章节编写指导
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spec/contributors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    贡献者
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1s.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64z"/></svg>
  
  <span class="md-ellipsis">
    运维基础
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            运维基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../checklist/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25m13.274 9.537zl-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074M4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5M4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75"/></svg>
  
  <span class="md-ellipsis">
    检查单
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../server/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.83 11.17a4.01 4.01 0 0 1 0 5.66 4.01 4.01 0 0 1-5.66 0zM6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m1 2a1 1 0 0 0-1 1 1 1 0 0 0 1 1 1 1 0 0 0 1-1 1 1 0 0 0-1-1m3 0a1 1 0 0 0-1 1 1 1 0 0 0 1 1 1 1 0 0 0 1-1 1 1 0 0 0-1-1m2 4a6 6 0 0 0-6 6 6 6 0 0 0 6 6 6 6 0 0 0 6-6 6 6 0 0 0-6-6"/></svg>
  
  <span class="md-ellipsis">
    服务器介绍
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../package/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.12 5h13.75l-.94-1h-12zm15.42.23c.29.34.46.77.46 1.27V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6.5c0-.5.17-.93.46-1.27l1.38-1.68C5.12 3.21 5.53 3 6 3h12c.47 0 .88.21 1.15.55zM6 18h6v-3H6z"/></svg>
  
  <span class="md-ellipsis">
    包管理系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../service/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5a2 2 0 0 1 2 2q0 .36-.12.69C17.95 8.5 21 11.91 21 16H3c0-4.09 3.05-7.5 7.12-8.31Q10 7.36 10 7a2 2 0 0 1 2-2m10 14H2v-2h20z"/></svg>
  
  <span class="md-ellipsis">
    服务与日志管理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../storage/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m6 2a6 6 0 0 0-6 6c0 3.31 2.69 6 6.1 6l-.88-2.23a1.01 1.01 0 0 1 .37-1.37l.86-.5a1.01 1.01 0 0 1 1.37.37l1.92 2.42A5.98 5.98 0 0 0 18 10a6 6 0 0 0-6-6m0 5a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-5 9a1 1 0 0 0-1 1 1 1 0 0 0 1 1 1 1 0 0 0 1-1 1 1 0 0 0-1-1m5.09-4.73 2.49 6.31 2.59-1.5-4.22-5.31z"/></svg>
  
  <span class="md-ellipsis">
    存储系统
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            存储系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    基础知识简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/filesystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分区与文件系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/lvm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LVM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/raid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAID
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    网络存储系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/backup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    备份与文件传输工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/zfs/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32h320c12.4 0 23.7 7.2 29 18.4s3.6 24.5-4.4 34.1L100.3 416H352c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-12.4 0-23.7-7.2-29-18.4s-3.6-24.5 4.4-34.1L283.7 96H32C14.3 96 0 81.7 0 64"/></svg>
  
  <span class="md-ellipsis">
    ZFS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../network/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 19h1a1 1 0 0 1 1 1h7v2h-7a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1H2v-2h7a1 1 0 0 1 1-1h1v-2H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1h-7zM4 3h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m5 4h1V5H9zm0 8h1v-2H9zM5 5v2h2V5zm0 8v2h2v-2z"/></svg>
  
  <span class="md-ellipsis">
    网络系统
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            网络系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    基础知识简介
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../network-service/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8c0 2.09.8 4 2.11 5.41l3.77-7.53 7.53-3.77A7.93 7.93 0 0 0 12 4m0 16a8 8 0 0 0 8-8c0-2.09-.8-4-2.11-5.41l-3.77 7.53-7.53 3.77A7.93 7.93 0 0 0 12 20m0-8-.77-.77L9.7 14.3l3.07-1.53zm0 5.5h1V19h-1zm3.88-1.61.71-.71 1.06 1.06-.71.71zM17.5 12v-1H19v1zM12 6.5h-1V5h1zM8.12 8.11l-.71.71-1.06-1.06.71-.71zM6.5 12v1H5v-1z"/></svg>
  
  <span class="md-ellipsis">
    网络服务实践
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            网络服务实践
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-service/ntp/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12.5v4l3 2 .75-1.25-2.25-1.5V12.5zm7-.11V12c0-5.5-4.5-10-10-10C6.47 2 2 6.5 2 12s4.5 10 10 10c.13 0 .24 0 .37-.03 1.06.65 2.3 1.03 3.63 1.03 3.86 0 7-3.14 7-7 0-1.32-.38-2.56-1-3.61m-2.24-2.28-.17-.11h.15c.01.03.01.07.02.11M18.92 8h-2.95a15.7 15.7 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M9.66 10h2.75a7 7 0 0 0-2.84 3.24c-.04-.41-.07-.82-.07-1.24 0-.68.06-1.35.16-2M9.4 4.44C8.8 5.55 8.35 6.75 8 8H5.08A7.92 7.92 0 0 1 9.4 4.44M4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2zm.82 2H8c.35 1.25.8 2.45 1.4 3.56A8 8 0 0 1 5.08 16M16 21c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"/></svg>
  
  <span class="md-ellipsis">
    网络时间同步
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-service/intranet/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12v10h20V12c0-5.5-4.5-10-10-10m3.47 5.11A5.95 5.95 0 0 0 13 6.09V4.07c1.46.18 2.79.76 3.9 1.62zm-6.94 0L7.1 5.69A7.94 7.94 0 0 1 11 4.07v2.02c-.91.15-1.75.51-2.47 1.02M5.69 7.1l1.42 1.43A5.95 5.95 0 0 0 6.09 11H4.07c.18-1.46.76-2.79 1.62-3.9M6 13v2.5H4V13zm-2 7v-2.5h2V20zm12 0H8v-8c0-2.21 1.79-4 4-4s4 1.79 4 4zm.89-11.47 1.42-1.43a7.94 7.94 0 0 1 1.62 3.9h-2.02a5.95 5.95 0 0 0-1.02-2.47M18 13h2v2.5h-2zm0 7v-2.5h2V20z"/></svg>
  
  <span class="md-ellipsis">
    隧道组网
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-service/nginx/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0 1.605 6v12L12 24l10.395-6V6zm6 16.59c0 .705-.646 1.29-1.529 1.29-.631 0-1.351-.255-1.801-.81l-6-7.141v6.66c0 .721-.57 1.29-1.274 1.29H7.32c-.721 0-1.29-.6-1.29-1.29V7.41c0-.705.63-1.29 1.5-1.29.646 0 1.38.255 1.83.81l5.97 7.141V7.41c0-.721.6-1.29 1.29-1.29h.075c.72 0 1.29.6 1.29 1.29v9.18z"/></svg>
  
  <span class="md-ellipsis">
    Nginx 服务器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-service/zeroconf/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4v2h1a1 1 0 0 1 1 1h7v2h-7a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1H2v-2h7a1 1 0 0 1 1-1h1v-2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm-4.81 2c-.87 0-1.57.2-2.11.59-.52.41-.78.98-.77 1.77l.01.03h1.93c.01-.3.1-.53.28-.69a1 1 0 0 1 .66-.23c.31 0 .57.1.75.28.18.19.26.45.26.75 0 .32-.07.59-.23.82-.14.23-.35.43-.61.59-.51.34-.86.64-1.05.91-.2.26-.31.68-.31 1.18h2c0-.31.04-.56.13-.74.09-.19.26-.36.51-.52.45-.24.82-.53 1.11-.93s.44-.81.44-1.31c0-.76-.27-1.37-.81-1.82-.53-.45-1.26-.68-2.19-.68M11 12v2h2v-2z"/></svg>
  
  <span class="md-ellipsis">
    Zeroconf
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../database/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4"/></svg>
  
  <span class="md-ellipsis">
    数据库
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            数据库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/rdbms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关系型数据库
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/kv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    键值数据库
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 12h-4v-2h4m0 6h-4v-2h4m6-6h-2.81a6 6 0 0 0-1.82-1.96L17 4.41 15.59 3l-2.17 2.17a6 6 0 0 0-2.83 0L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20z"/></svg>
  
  <span class="md-ellipsis">
    问题调试
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 12h-4v-2h4m0 6h-4v-2h4m6-6h-2.81a6 6 0 0 0-1.82-1.96L17 4.41 15.59 3l-2.17 2.17a6 6 0 0 0-2.83 0L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20z"/></svg>
  
  <span class="md-ellipsis">
    问题调试
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      快速检查单
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#status-and-logs" class="md-nav__link">
    <span class="md-ellipsis">
      服务状态与日志
    </span>
  </a>
  
    <nav class="md-nav" aria-label="服务状态与日志">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logs-intro" class="md-nav__link">
    <span class="md-ellipsis">
      日志简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-panic-and-pstore" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel panic 与 pstore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procfs-and-strace" class="md-nav__link">
    <span class="md-ellipsis">
      procfs 与 strace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug-symbols-and-gdb" class="md-nav__link">
    <span class="md-ellipsis">
      调试符号与 gdb
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-debug" class="md-nav__link">
    <span class="md-ellipsis">
      网络问题调试简介
    </span>
  </a>
  
    <nav class="md-nav" aria-label="网络问题调试简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectivity-issues" class="md-nav__link">
    <span class="md-ellipsis">
      连通性问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="连通性问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#curl" class="md-nav__link">
    <span class="md-ellipsis">
      curl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc" class="md-nav__link">
    <span class="md-ellipsis">
      nc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtr" class="md-nav__link">
    <span class="md-ellipsis">
      mtr
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dig" class="md-nav__link">
    <span class="md-ellipsis">
      dig 与 DNS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip" class="md-nav__link">
    <span class="md-ellipsis">
      ip
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-check" class="md-nav__link">
    <span class="md-ellipsis">
      性能检查
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-packet-capture" class="md-nav__link">
    <span class="md-ellipsis">
      网络抓包
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      性能问题分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="性能问题分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flamegraph" class="md-nav__link">
    <span class="md-ellipsis">
      火焰图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-counter" class="md-nav__link">
    <span class="md-ellipsis">
      获取硬件计数器统计信息
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      eBPF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="eBPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      内核态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-space-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      用户态
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplement" class="md-nav__link">
    <span class="md-ellipsis">
      补充阅读
    </span>
  </a>
  
    <nav class="md-nav" aria-label="补充阅读">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supplement-books" class="md-nav__link">
    <span class="md-ellipsis">
      书籍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supplement-sites" class="md-nav__link">
    <span class="md-ellipsis">
      站点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../virtualization/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m10.15 8.98 1.647.951-5.756 3.345.005-1.911zm1.723-1.001-1.553.902 1.548.893zM6.028 5.33 6.025 6.4l.543.316 3.602 2.079 1.632-.948-2.19-1.279-3.231-1.887-.351-.203zm.072-.983.359.209 6.321 3.65 5.258 3.037 5.858-3.405L11.956.943zm6.002 12.602-.005 1.924 5.858-3.404.005-1.924zm-.077-9.009-.005 1.922 5.94 3.428.005-1.92zm-10.13.945 4.075 2.352 4.031-2.342-4.075-2.353zM24 7.982l-5.858 3.404-.015 3.982 5.858-3.404zm-12.048 10.04.003-1.073L7.6 14.436l-1.565-.903v.001l-.939-.542L.015 10.06.01 11.979l11.94 6.895zm5.935-4.605-5.922-3.411-5.853 3.401 5.917 3.414zm6.072-1.238-11.862 6.864-.01 4.013 11.863-6.894zM11.944 21.27l.005-2.227L.01 12.148 0 16.162l11.94 6.895zM.021 9.802 1.6 8.885.025 7.976zm5.832-3.39.024-1.636.001-.296L.099 7.848l1.647.951zm.041 4.951L1.749 8.97l-.46.267-1.195.695 5.795 3.345z"/></svg>
  
  <span class="md-ellipsis">
    虚拟化技术
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            虚拟化技术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../virtualization/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    基础知识简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../virtualization/container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    容器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../virtualization/qemu-kvm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QEMU/KVM
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../accounts/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 12A2.5 2.5 0 0 0 19 9.5 2.5 2.5 0 0 0 16.5 7 2.5 2.5 0 0 0 14 9.5a2.5 2.5 0 0 0 2.5 2.5M9 11a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75M9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.47C10.5 13.1 9.66 13 9 13"/></svg>
  
  <span class="md-ellipsis">
    用户账户系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_13" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../monitor/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 4v12h18V4zm0-2h18a2 2 0 0 1 2 2v12c0 .53-.21 1.04-.59 1.41-.37.38-.88.59-1.41.59h-7v2h2v2H8v-2h2v-2H3c-.53 0-1.04-.21-1.41-.59C1.21 17.04 1 16.53 1 16V4c0-1.11.89-2 2-2m7.84 6.93c.31-.3.73-.48 1.16-.48.43.01.85.18 1.16.49.3.3.48.72.48 1.15 0 .44-.18.85-.48 1.16-.31.31-.73.48-1.16.48s-.85-.18-1.16-.48c-.3-.31-.48-.72-.48-1.16 0-.43.18-.85.48-1.16M10.07 12a2.68 2.68 0 0 0 3.86 0c.51-.5.8-1.19.8-1.91s-.29-1.42-.8-1.93-1.21-.8-1.93-.8-1.42.29-1.93.8-.8 1.21-.8 1.93.29 1.41.8 1.91M6 10.09A6.45 6.45 0 0 1 12 6c2.73 0 5.06 1.7 6 4.09a6.42 6.42 0 0 1-6 4.09c-2.73 0-5.06-1.68-6-4.09"/></svg>
  
  <span class="md-ellipsis">
    指标监控与告警
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_13" id="__nav_5_13_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_13">
            <span class="md-nav__icon md-icon"></span>
            指标监控与告警
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitor/local/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    本机指标收集
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitor/telegraf/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m23.778 14.482-2.287-9.959c-.13-.545-.624-1.09-1.169-1.248L9.87.051C9.74 0 9.584 0 9.426 0c-.443 0-.909.18-1.222.443L.716 7.412C.3 7.776.092 8.504.222 9.024l2.445 10.662c.13.545.624 1.092 1.169 1.248l9.775 3.015c.13.051.285.051.443.051.443 0 .91-.18 1.223-.443l8.007-7.435c.418-.39.624-1.092.494-1.64M10.962 2.417l7.175 2.21c.285.08.285.21 0 .286l-3.77.858c-.285.08-.674-.05-.883-.26l-2.626-2.834c-.235-.232-.184-.336.104-.26m4.47 12.872c.079.286-.105.444-.39.365l-7.748-2.392c-.285-.079-.338-.313-.13-.52l5.93-5.514c.209-.209.443-.13.52.156zM2.667 8.267l6.293-5.85c.21-.209.545-.18.754.025L12.86 5.85c.209.21.18.545-.026.754l-6.293 5.85c-.21.21-.545.181-.754-.025L2.64 9.024a.536.536 0 0 1 .026-.757zm1.536 9.284L2.54 10.244c-.08-.285.05-.34.234-.13L5.4 12.949c.209.209.285.624.209.909L4.462 17.55c-.079.285-.208.285-.26 0zm9.202 4.264-8.217-2.522a.547.547 0 0 1-.364-.675l1.378-4.421a.547.547 0 0 1 .675-.365l8.216 2.522c.285.079.443.39.364.675L14.08 21.45a.553.553 0 0 1-.674.365zm7.279-5.98L15.2 20.93c-.209.209-.31.13-.234-.155l1.144-3.694c.079-.285.39-.573.674-.624l3.77-.858c.288-.076.339.054.13.234zm.598-1.09-4.523 1.039a.534.534 0 0 1-.65-.39l-1.922-8.372a.534.534 0 0 1 .39-.65L19.1 5.335a.534.534 0 0 1 .649.39l1.923 8.371c.079.31-.102.596-.39.65Z"/></svg>
  
  <span class="md-ellipsis">
    Telegraf + InfluxDB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitor/prometheus/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.372 0 12c0 6.627 5.373 12 12 12s12-5.373 12-12c0-6.628-5.373-12-12-12m0 22.46c-1.885 0-3.414-1.26-3.414-2.814h6.828c0 1.553-1.528 2.813-3.414 2.813zm5.64-3.745H6.36v-2.046h11.28zm-.04-3.098H6.391q-.056-.064-.111-.13c-1.155-1.401-1.427-2.133-1.69-2.879-.005-.025 1.4.287 2.395.511 0 0 .513.119 1.262.255-.72-.843-1.147-1.915-1.147-3.01 0-2.406 1.845-4.508 1.18-6.207.648.053 1.34 1.367 1.387 3.422.689-.951.977-2.69.977-3.755 0-1.103.727-2.385 1.454-2.429-.648 1.069.168 1.984.894 4.256.272.854.237 2.29.447 3.201.07-1.892.395-4.652 1.595-5.605-.529 1.2.079 2.702.494 3.424.671 1.164 1.078 2.047 1.078 3.716a4.64 4.64 0 0 1-1.11 2.996c.792-.149 1.34-.283 1.34-.283l2.573-.502s-.374 1.538-1.81 3.019z"/></svg>
  
  <span class="md-ellipsis">
    Prometheus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitor/grafana/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.02 10.59a8.6 8.6 0 0 0-.862-3.034 8.9 8.9 0 0 0-1.789-2.445c.337-1.342-.413-2.505-.413-2.505-1.292-.08-2.113.4-2.416.62q-.077-.032-.154-.064-.33-.134-.677-.247-.348-.11-.711-.197a10 10 0 0 0-.875-.161C14.557.753 12.94 0 12.94 0c-1.804 1.145-2.147 2.744-2.147 2.744l-.018.093q-.149.042-.298.088c-.138.042-.275.094-.413.143-.138.055-.275.107-.41.166a9 9 0 0 0-1.557.87l-.063-.029c-2.497-.955-4.716.195-4.716.195-.203 2.658.996 4.33 1.235 4.636a11.6 11.6 0 0 0-.607 2.635C1.636 12.677.953 15.014.953 15.014c1.926 2.214 4.171 2.351 4.171 2.351q.005-.002.006-.005c.285.509.615.994.986 1.446q.235.284.488.548c-.704 2.009.099 3.68.099 3.68 2.144.08 3.553-.937 3.849-1.173a9.8 9.8 0 0 0 3.164.501h.08l.055-.003.107-.002.103-.005.003.002c1.01 1.44 2.788 1.646 2.788 1.646 1.264-1.332 1.337-2.653 1.337-2.94v-.058q-.002-.03-.003-.06.4-.28.758-.6a7.9 7.9 0 0 0 1.415-1.7c1.43.083 2.437-.885 2.437-.885-.236-1.49-1.085-2.216-1.264-2.354l-.018-.013-.016-.013-.031-.02q.013-.137.02-.27.016-.244.016-.48v-.253l-.005-.098-.008-.135a2 2 0 0 0-.01-.13q-.005-.063-.013-.125l-.016-.124-.018-.122a6.2 6.2 0 0 0-2.032-3.73 6 6 0 0 0-3.222-1.46 6 6 0 0 0-.85-.048l-.107.002h-.063l-.044.003-.104.008a4.78 4.78 0 0 0-3.335 1.695c-.332.4-.592.84-.768 1.297a4.6 4.6 0 0 0-.312 1.817l.003.091q.006.083.013.164a3.6 3.6 0 0 0 .698 1.82 3.53 3.53 0 0 0 1.827 1.282c.33.098.66.14.971.137q.06 0 .114-.002l.063-.003q.03-.002.062-.003.05-.004.099-.01.012-.001.028-.003l.031-.005.06-.008a1 1 0 0 0 .112-.02c.036-.008.072-.013.109-.024a2.6 2.6 0 0 0 .914-.415q.042-.03.085-.065a.25.25 0 0 0 .039-.35.244.244 0 0 0-.309-.06l-.078.042q-.135.066-.283.116a2.5 2.5 0 0 1-.475.096q-.04.005-.083.006l-.083.002q-.04 0-.08-.002l-.102-.006h-.012l-.024.006q-.024-.003-.044-.006-.046-.004-.091-.01a2.6 2.6 0 0 1-.724-.213 2.6 2.6 0 0 1-.667-.438 2.52 2.52 0 0 1-.805-1.475 2.3 2.3 0 0 1-.029-.444l.006-.122v-.023l.002-.031q.003-.03.005-.06a3.16 3.16 0 0 1 1.352-2.29 3.1 3.1 0 0 1 .937-.43 3 3 0 0 1 .776-.101h.06l.07.002.045.003h.026l.07.005a4 4 0 0 1 1.635.49 3.94 3.94 0 0 1 1.602 1.662 3.8 3.8 0 0 1 .397 1.414l.005.076.003.075q.002.038.002.075c0 .024.003.052 0 .07v.065l-.002.073-.008.174a6 6 0 0 1-.08.639 5 5 0 0 1-.267.927 5.3 5.3 0 0 1-.624 1.13 5.05 5.05 0 0 1-3.237 2.014 5 5 0 0 1-.649.066l-.039.003h-.287a6.6 6.6 0 0 1-1.716-.265 6.78 6.78 0 0 1-3.4-2.274 6.8 6.8 0 0 1-.746-1.15 6.6 6.6 0 0 1-.714-2.596l-.005-.083-.002-.02v-.056l-.003-.073v-.096l-.003-.104v-.07l.003-.163c.008-.22.026-.45.054-.678a9 9 0 0 1 .28-1.355q.192-.668.473-1.277a7 7 0 0 1 1.456-2.1 6 6 0 0 1 .953-.763q.253-.166.524-.306c.089-.05.182-.091.273-.135q.07-.031.138-.062a7 7 0 0 1 .714-.267l.145-.045c.049-.015.098-.026.148-.041q.147-.042.296-.076c.049-.013.1-.02.15-.033l.15-.032.151-.028.076-.013.075-.01.153-.024c.057-.01.114-.013.171-.023l.169-.021q.055-.006.106-.01l.073-.008.036-.003.042-.002q.086-.006.171-.01l.086-.006h.023l.037-.003.145-.007a8 8 0 0 1 1.708.125 8 8 0 0 1 2.048.68 8.3 8.3 0 0 1 1.672 1.09l.09.077.089.078c.06.052.114.107.171.159q.085.079.166.16.08.08.159.164a8.7 8.7 0 0 1 1.41 1.978c.012.026.028.052.04.078l.04.078.075.156c.023.051.05.1.07.153l.065.15a9 9 0 0 1 .45 1.34.19.19 0 0 0 .201.142.186.186 0 0 0 .172-.184q.015-.37-.024-.856z"/></svg>
  
  <span class="md-ellipsis">
    Grafana
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12h7c-.53 4.11-3.28 7.78-7 8.92zH5V6.3l7-3.11M12 1 3 5v6c0 5.55 3.84 10.73 9 12 5.16-1.27 9-6.45 9-12V5z"/></svg>
  
  <span class="md-ellipsis">
    安全
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../dev/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"/></svg>
  
  <span class="md-ellipsis">
    开发速查手册
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            开发速查手册
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../dev/language/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.89 3 1.96.4L11.11 21l-1.96-.4zm6.7 9L16 8.41V5.58L22.42 12 16 18.41v-2.83zM1.58 12 8 5.58v2.83L4.41 12 8 15.58v2.83z"/></svg>
  
  <span class="md-ellipsis">
    编程语言与工具
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            编程语言与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/language/frontend/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.5 0h21l-1.91 21.563L11.977 24l-8.564-2.438zm7.031 9.75-.232-2.718 10.059.003.23-2.622L5.412 4.41l.698 8.01h9.126l-.326 3.426-2.91.804-2.955-.81-.188-2.11H6.248l.33 4.171L12 19.351l5.379-1.443.744-8.157z"/></svg>
  
  <span class="md-ellipsis">
    前端简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/language/python/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg>
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/language/cxx/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.394 6c-.167-.29-.398-.543-.652-.69L12.926.22c-.509-.294-1.34-.294-1.848 0L2.26 5.31c-.508.293-.923 1.013-.923 1.6v10.18c0 .294.104.62.271.91s.398.543.652.69l8.816 5.09c.508.293 1.34.293 1.848 0l8.816-5.09c.254-.147.485-.4.652-.69s.27-.616.27-.91V6.91c.003-.294-.1-.62-.268-.91M12 19.11c-3.92 0-7.109-3.19-7.109-7.11s3.19-7.11 7.11-7.11a7.13 7.13 0 0 1 6.156 3.553l-3.076 1.78a3.57 3.57 0 0 0-3.08-1.78A3.56 3.56 0 0 0 8.444 12 3.56 3.56 0 0 0 12 15.555a3.57 3.57 0 0 0 3.08-1.778l3.078 1.78A7.14 7.14 0 0 1 12 19.11m7.11-6.715h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79zm2.962 0h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79z"/></svg>
  
  <span class="md-ellipsis">
    C/C++ 与构建工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/language/shell/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.038 4.9 13.461.402a2.86 2.86 0 0 0-2.923.001L2.961 4.9A3.02 3.02 0 0 0 1.5 7.503v8.995c0 1.073.557 2.066 1.462 2.603l7.577 4.497a2.86 2.86 0 0 0 2.922 0l7.577-4.497a3.02 3.02 0 0 0 1.462-2.603V7.503A3.02 3.02 0 0 0 21.038 4.9M15.17 18.946l.013.646c.001.078-.05.167-.111.198l-.383.22c-.061.031-.111-.007-.112-.085l-.007-.635c-.328.136-.66.169-.872.084-.04-.016-.057-.075-.041-.142l.139-.584a.24.24 0 0 1 .069-.121.2.2 0 0 1 .036-.026q.033-.017.062-.006c.229.077.521.041.802-.101.357-.181.596-.545.592-.907-.003-.328-.181-.465-.613-.468-.55.001-1.064-.107-1.072-.917-.007-.667.34-1.361.889-1.8l-.007-.652c-.001-.08.048-.168.111-.2l.37-.236c.061-.031.111.007.112.087l.006.653c.273-.109.511-.138.726-.088.047.012.067.076.048.151l-.144.578a.26.26 0 0 1-.065.116.2.2 0 0 1-.038.028.1.1 0 0 1-.057.009c-.098-.022-.332-.073-.699.113-.385.195-.52.53-.517.778.003.297.155.387.681.396.7.012 1.003.318 1.01 1.023.007.689-.362 1.433-.928 1.888m3.973-1.087c0 .06-.008.116-.058.145l-1.916 1.164c-.05.029-.09.004-.09-.056v-.494c0-.06.037-.093.087-.122l1.887-1.129c.05-.029.09-.004.09.056zm1.316-11.062-7.168 4.427c-.894.523-1.553 1.109-1.553 2.187v8.833c0 .645.26 1.063.66 1.184a2.3 2.3 0 0 1-.398.039c-.42 0-.833-.114-1.197-.33L3.226 18.64a2.5 2.5 0 0 1-1.201-2.142V7.503c0-.881.46-1.702 1.201-2.142L10.803.863a2.34 2.34 0 0 1 2.394 0l7.577 4.498a2.48 2.48 0 0 1 1.164 1.732c-.252-.536-.818-.682-1.479-.296"/></svg>
  
  <span class="md-ellipsis">
    Shell 脚本
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/language/golang/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.811 10.231c-.047 0-.058-.023-.035-.059l.246-.315c.023-.035.081-.058.128-.058h4.172c.046 0 .058.035.035.07l-.199.303c-.023.036-.082.07-.117.07zM.047 11.306c-.047 0-.059-.023-.035-.058l.245-.316c.023-.035.082-.058.129-.058h5.328c.047 0 .07.035.058.07l-.093.28c-.012.047-.058.07-.105.07zm2.828 1.075c-.047 0-.059-.035-.035-.07l.163-.292c.023-.035.07-.07.117-.07h2.337c.047 0 .07.035.07.082l-.023.28c0 .047-.047.082-.082.082zm12.129-2.36c-.736.187-1.239.327-1.963.514-.176.046-.187.058-.34-.117-.174-.199-.303-.327-.548-.444-.737-.362-1.45-.257-2.115.175-.795.514-1.204 1.274-1.192 2.22.011.935.654 1.706 1.577 1.835.795.105 1.46-.175 1.987-.77.105-.13.198-.27.315-.434H10.47c-.245 0-.304-.152-.222-.35.152-.362.432-.97.596-1.274a.32.32 0 0 1 .292-.187h4.253c-.023.316-.023.631-.07.947a5 5 0 0 1-.958 2.29c-.841 1.11-1.94 1.8-3.33 1.986-1.145.152-2.209-.07-3.143-.77-.865-.655-1.356-1.52-1.484-2.595-.152-1.274.222-2.419.993-3.424.83-1.086 1.928-1.776 3.272-2.02 1.098-.2 2.15-.07 3.096.571.62.41 1.063.97 1.356 1.648.07.105.023.164-.117.2m3.868 6.461c-1.064-.024-2.034-.328-2.852-1.029a3.67 3.67 0 0 1-1.262-2.255c-.21-1.32.152-2.489.947-3.529.853-1.122 1.881-1.706 3.272-1.95 1.192-.21 2.314-.095 3.33.595.923.63 1.496 1.484 1.648 2.605.198 1.578-.257 2.863-1.344 3.962-.771.783-1.718 1.273-2.805 1.495-.315.06-.63.07-.934.106m2.78-4.72c-.011-.153-.011-.27-.034-.387-.21-1.157-1.274-1.81-2.384-1.554-1.087.245-1.788.935-2.045 2.033-.21.912.234 1.835 1.075 2.21.643.28 1.285.244 1.905-.07.923-.48 1.425-1.228 1.484-2.233z"/></svg>
  
  <span class="md-ellipsis">
    Golang
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/git/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.546 10.93 13.067.452a1.55 1.55 0 0 0-2.188 0L8.708 2.627l2.76 2.76a1.838 1.838 0 0 1 2.327 2.341l2.658 2.66a1.838 1.838 0 0 1 1.9 3.039 1.837 1.837 0 0 1-2.6 0 1.85 1.85 0 0 1-.404-1.996L12.86 8.955v6.525c.176.086.342.203.488.348a1.85 1.85 0 0 1 0 2.6 1.844 1.844 0 0 1-2.609 0 1.834 1.834 0 0 1 0-2.598c.182-.18.387-.316.605-.406V8.835a1.834 1.834 0 0 1-.996-2.41L7.636 3.7.45 10.881c-.6.605-.6 1.584 0 2.189l10.48 10.477a1.545 1.545 0 0 0 2.186 0l10.43-10.43a1.544 1.544 0 0 0 0-2.187"/></svg>
  
  <span class="md-ellipsis">
    版本管理与合作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/ssh/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4.5 9c-.6 0-1 .5-1 1v1.75c0 .5.4 1 1 1H7v.75H3.5V15h4c.6 0 1-.5 1-1v-1.75c0-.5-.4-1-1-1H5v-.75h3.5V9zm6 0c-.6 0-1 .5-1 1v1.75c0 .5.4 1 1 1H13v.75H9.5V15h4c.6 0 1-.5 1-1v-1.75c0-.5-.4-1-1-1H11v-.75h3.5V9zm5 0v6H17v-2.5h2V15h1.5V9H19v2h-2V9z"/></svg>
  
  <span class="md-ellipsis">
    SSH 使用技巧
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../advanced/" class="md-nav__link ">
              
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13a9 9 0 0 0 9 9c0-5-4.03-9-9-9m9-7.5A2.5 2.5 0 0 1 14.5 8a2.5 2.5 0 0 1-2.5 2.5A2.5 2.5 0 0 1 9.5 8 2.5 2.5 0 0 1 12 5.5m-6.4 4.75a2.5 2.5 0 0 0 2.5 2.5c.53 0 1.02-.17 1.4-.44v.19A2.5 2.5 0 0 0 12 15a2.5 2.5 0 0 0 2.5-2.5v-.19c.38.27.87.44 1.4.44a2.5 2.5 0 0 0 2.5-2.5c0-1-.59-1.85-1.43-2.25.84-.4 1.43-1.26 1.43-2.25a2.5 2.5 0 0 0-2.5-2.5c-.53 0-1.02.16-1.4.44V3.5A2.5 2.5 0 0 0 12 1a2.5 2.5 0 0 0-2.5 2.5v.19c-.38-.28-.87-.44-1.4-.44a2.5 2.5 0 0 0-2.5 2.5c0 .99.59 1.85 1.43 2.25-.84.4-1.43 1.25-1.43 2.25M12 22a9 9 0 0 0 9-9c-5 0-9 4-9 9"/></svg>
  
  <span class="md-ellipsis">
    高级内容
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            高级内容
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/cuda/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.948 8.798v-1.43a7 7 0 0 1 .424-.018c3.922-.124 6.493 3.374 6.493 3.374s-2.774 3.851-5.75 3.851a3.7 3.7 0 0 1-1.158-.185v-4.346c1.528.185 1.837.857 2.747 2.385l2.04-1.714s-1.492-1.952-4-1.952a6 6 0 0 0-.796.035m0-4.735v2.138l.424-.027c5.45-.185 9.01 4.47 9.01 4.47s-4.08 4.964-8.33 4.964a6.5 6.5 0 0 1-1.095-.097v1.325c.3.035.61.062.91.062 3.957 0 6.82-2.023 9.593-4.408.459.371 2.34 1.263 2.73 1.652-2.633 2.208-8.772 3.984-12.253 3.984-.335 0-.653-.018-.971-.053v1.864H24V4.063zm0 10.326v1.131c-3.657-.654-4.673-4.46-4.673-4.46s1.758-1.944 4.673-2.262v1.237H8.94c-1.528-.186-2.73 1.245-2.73 1.245s.68 2.412 2.739 3.11M2.456 10.9s2.164-3.197 6.5-3.533V6.201C4.153 6.59 0 10.653 0 10.653s2.35 6.802 8.948 7.42v-1.237c-4.84-.6-6.492-5.936-6.492-5.936"/></svg>
  
  <span class="md-ellipsis">
    CUDA 环境简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/desktop/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M14.25 1c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 14.25 12h-3.727c.099 1.041.52 1.872 1.292 2.757A.752.752 0 0 1 11.25 16h-6.5a.75.75 0 0 1-.565-1.243c.772-.885 1.192-1.716 1.292-2.757H1.75A1.75 1.75 0 0 1 0 10.25v-7.5C0 1.784.784 1 1.75 1ZM1.75 2.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25ZM9.018 12H6.982a5.7 5.7 0 0 1-.765 2.5h3.566a5.7 5.7 0 0 1-.765-2.5"/></svg>
  
  <span class="md-ellipsis">
    Linux 桌面与窗口系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/dac-mac/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 19h1a1 1 0 0 1 1 1h7v2h-7a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1H2v-2h7a1 1 0 0 1 1-1h1v-1.66C8.07 16.13 6 13 6 9.67v-4L12 3l6 2.67v4c0 3.33-2.07 6.46-5 7.67zM12 5 8 6.69V10h4zm0 5v6c1.91-.47 4-2.94 4-5v-1z"/></svg>
  
  <span class="md-ellipsis">
    DAC 与 MAC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/caddy/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.094.47c-.842 0-1.696.092-2.552.288a11.4 11.4 0 0 0-4.87 2.423 10.6 10.6 0 0 0-2.36 2.826A10.1 10.1 0 0 0 .305 8.582c-.398 1.62-.4 3.336-.043 5.048.085.405.183.809.31 1.212a11.9 11.9 0 0 0 1.662 3.729 3 3 0 0 0-.086.427 3.323 3.323 0 0 0 2.848 3.71 3.28 3.28 0 0 0 1.947-.346c1.045.51 2.17.864 3.339 1.04a11.7 11.7 0 0 0 4.285-.155 11.57 11.57 0 0 0 4.936-2.485 10.6 10.6 0 0 0 2.352-2.894 11.2 11.2 0 0 0 1.356-4.424 11.2 11.2 0 0 0-.498-4.335q.263-.116.486-.293h.001c.402-.322.693-.794.777-1.342a2.146 2.146 0 0 0-1.79-2.434 2.1 2.1 0 0 0-1.205.171q-.059-.064-.113-.13a11.7 11.7 0 0 0-3.476-2.93 13 13 0 0 0-1.76-.81 13.6 13.6 0 0 0-2.06-.613 12 12 0 0 0-2.48-.258Zm.714.328a10 10 0 0 1 1.028.042 9.9 9.9 0 0 1 2.743.639c.984.39 1.89.958 2.707 1.632a10.8 10.8 0 0 1 2.091 2.328q.038.06.07.12a2.12 2.12 0 0 0-.435 2.646c-.158.114-.97.692-1.634 1.183-.414.308-.733.557-.733.557l.581.68s.296-.276.665-.638c.572-.562 1.229-1.233 1.395-1.403a2.12 2.12 0 0 0 1.907.677 11.2 11.2 0 0 1-.013 4.046 11.4 11.4 0 0 1-1.475 3.897 12.3 12.3 0 0 1-2.079 2.587c-1.19 1.125-2.633 2.022-4.306 2.531a10.8 10.8 0 0 1-3.973.484 11 11 0 0 1-3.057-.652 3.3 3.3 0 0 0 1.417-2.294 3.28 3.28 0 0 0-.294-1.842c.18-.162.403-.363.656-.6 1.015-.955 2.353-2.303 2.353-2.303l-.47-.599s-1.63.972-2.801 1.728c-.307.198-.573.378-.777.517a3.3 3.3 0 0 0-1.516-.611 3.33 3.33 0 0 0-3.487 2.017 10 10 0 0 1-.695-1.078A11 11 0 0 1 .728 14.8a10 10 0 0 1-.2-1.212c-.164-1.653.103-3.258.629-4.754a13 13 0 0 1 1.087-2.288c.57-.968 1.248-1.872 2.069-2.656A11 11 0 0 1 11.808.797Zm-.147 3.257a3.84 3.84 0 0 0-3.82 3.82v2.36h-.94c-.751 0-1.377.625-1.377 1.377v3.8h1.46v-3.718h9.354v6.264H10.02v1.46h6.4c.751 0 1.377-.625 1.377-1.377v-6.43a1.39 1.39 0 0 0-1.377-1.377h-.94v-2.36a3.84 3.84 0 0 0-3.82-3.819zm0 1.46a2.37 2.37 0 0 1 2.36 2.36v2.36H9.3v-2.36a2.37 2.37 0 0 1 2.36-2.36zm10.141.392a1.253 1.253 0 0 1 1.296 1.434 1.24 1.24 0 0 1-.453.78c-.266.213-.61.318-.968.264a1.253 1.253 0 0 1-1.045-1.42 1.255 1.255 0 0 1 1.17-1.058M5.384 17.425a2.02 2.02 0 0 1 1.917 1.298c.116.3.159.628.114.967a2.015 2.015 0 0 1-2.249 1.728 2.016 2.016 0 0 1-1.727-2.25 2.02 2.02 0 0 1 1.945-1.743"/></svg>
  
  <span class="md-ellipsis">
    Caddy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/nmap/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 0C.9 0 0 .9 0 2v4h2V2h4V0zm16 0v2h4v4h2V2c0-1.1-.9-2-2-2zm-6 3c-4.4 0-8 3.6-8 8 0 2.5 1.2 4.8 3 6.2V21h2v-3h2v3h2v-3h2v3h2v-3.8c1.8-1.5 3-3.7 3-6.2 0-4.4-3.6-8-8-8M8 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2m2.5 2 1.5-3 1.5 3zm5.5-2c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2M0 18v4c0 1.1.9 2 2 2h4v-2H2v-4zm22 0v4h-4v2h4c1.1 0 2-.9 2-2v-4z"/></svg>
  
  <span class="md-ellipsis">
    Nmap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/elk/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.394 0C8.683 0 4.609 2.716 2.644 6.667h15.641a4.77 4.77 0 0 0 3.073-1.11c.446-.375.864-.785 1.247-1.243l.001-.002A11.97 11.97 0 0 0 13.394 0M1.804 8.889a12 12 0 0 0 0 6.222h14.7a3.111 3.111 0 1 0 0-6.222zm.84 8.444C4.61 21.283 8.684 24 13.395 24c3.701 0 7.011-1.677 9.212-4.312l-.001-.002a10 10 0 0 0-1.247-1.243 4.77 4.77 0 0 0-3.073-1.11z"/></svg>
  
  <span class="md-ellipsis">
    ELK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      快速检查单
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#status-and-logs" class="md-nav__link">
    <span class="md-ellipsis">
      服务状态与日志
    </span>
  </a>
  
    <nav class="md-nav" aria-label="服务状态与日志">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logs-intro" class="md-nav__link">
    <span class="md-ellipsis">
      日志简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-panic-and-pstore" class="md-nav__link">
    <span class="md-ellipsis">
      Kernel panic 与 pstore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procfs-and-strace" class="md-nav__link">
    <span class="md-ellipsis">
      procfs 与 strace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug-symbols-and-gdb" class="md-nav__link">
    <span class="md-ellipsis">
      调试符号与 gdb
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-debug" class="md-nav__link">
    <span class="md-ellipsis">
      网络问题调试简介
    </span>
  </a>
  
    <nav class="md-nav" aria-label="网络问题调试简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectivity-issues" class="md-nav__link">
    <span class="md-ellipsis">
      连通性问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="连通性问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#curl" class="md-nav__link">
    <span class="md-ellipsis">
      curl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nc" class="md-nav__link">
    <span class="md-ellipsis">
      nc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtr" class="md-nav__link">
    <span class="md-ellipsis">
      mtr
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dig" class="md-nav__link">
    <span class="md-ellipsis">
      dig 与 DNS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip" class="md-nav__link">
    <span class="md-ellipsis">
      ip
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-check" class="md-nav__link">
    <span class="md-ellipsis">
      性能检查
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-packet-capture" class="md-nav__link">
    <span class="md-ellipsis">
      网络抓包
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      性能问题分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="性能问题分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flamegraph" class="md-nav__link">
    <span class="md-ellipsis">
      火焰图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-counter" class="md-nav__link">
    <span class="md-ellipsis">
      获取硬件计数器统计信息
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      eBPF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="eBPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      内核态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-space-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      用户态
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplement" class="md-nav__link">
    <span class="md-ellipsis">
      补充阅读
    </span>
  </a>
  
    <nav class="md-nav" aria-label="补充阅读">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supplement-books" class="md-nav__link">
    <span class="md-ellipsis">
      书籍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supplement-sites" class="md-nav__link">
    <span class="md-ellipsis">
      站点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">问题调试<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">主要作者</p>
<p><a href="https://github.com/taoky">@taoky</a></p>
</div>
<div class="admonition warning">
<p class="admonition-title">本文已完成，等待校对</p>
</div>
<p>本部分介绍调试问题时的一般思路和方法。
请注意本部分无法面面俱到，因此只能够提供一些在运维上常用的方法，具体问题需要具体分析。</p>
<p>本文的部分内容可能会与其他部分的内容存在一定重复。</p>
<h2 id="quick-checklist">快速检查单<a class="headerlink" href="#quick-checklist" title="Permanent link">&para;</a></h2>
<p>以下提供在系统遇到异常情况时，可以快速检查的一些项目：</p>
<ul>
<li>系统负载<ul>
<li><code>uptime</code> 可以查看系统在过去 1 分钟、5 分钟、15 分钟的平均负载——这里的「负载」指的是正在等待 CPU 的进程数量（包括陷入不可中断睡眠的进程，大多数情况下处于这种状态的进程都在等待磁盘 I/O）。</li>
<li><a href="https://docs.kernel.org/accounting/psi.html">PSI（Pressure Stall Information）信息</a>可以确认系统的具体的压力情况。在 <code>/proc/pressure</code> 目录下可以看到 CPU、I/O、IRQ 以及内存的压力情况。只要有一个或多个进程需要缺少某种资源而等待，那么对应的时间就会被计入 <code>some</code> 行中；如果所有的进程都因为缺少某种资源而等待，那么对应的时间就会被计入 <code>full</code> 行中。<code>some</code> 和 <code>full</code> 中的 <code>avg10</code>、<code>avg60</code>、<code>avg300</code> 分别表示过去 10 秒、60 秒、300 秒的等待时间百分比（0 到 100）。<ul>
<li>PSI 可以精确到 <a href="../virtualization/container/#cgroups">cgroup</a>——每个 cgroup 下的 <code>*.pressure</code> 就是对应的压力信息。</li>
</ul>
</li>
<li><code>htop</code> 可以快速查看系统的 CPU、内存（包括 swap）以及进程情况。在进程数量很多的时候，<code>top</code> 的性能会更好一些（虽然易用性不如 <code>htop</code>）。</li>
<li><code>iostat 1</code> 可以每隔 1 秒输出一次磁盘 I/O 情况。</li>
</ul>
</li>
<li>系统日志<ul>
<li><code>journalctl -f</code></li>
<li><code>dmesg -w</code></li>
<li>检查硬件是否发生错误：<code>ras-mc-ctl --summary</code>，需要提前安装 <code>rasdaemon</code> 包。</li>
</ul>
</li>
<li>资源使用情况<ul>
<li><code>df -h</code> 可以查看磁盘空间使用情况。</li>
<li><code>iotop</code> 可以按进程查看磁盘 I/O 情况。<ul>
<li>iotop 有两个不同的版本，在各个发行版中一般分为 <code>iotop</code> 和 <code>iotop-c</code>。前者已经停止维护，因此<strong>推荐安装 <code>iotop-c</code></strong>。</li>
</ul>
</li>
<li><code>iftop</code> 可以查看对应接口到每个远端 IP 的网络流量情况。<ul>
<li>如果需要按进程查看网络流量情况，可以使用 <code>nethogs</code>。</li>
<li>如果只需要接口的总数据，可以使用 <code>bmon</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">系统几乎/完全无法操作</p>
<p>不幸的是，有些时候出现问题的系统会卡在那里，无法操作，这可能是因为内存几乎已满（OOM），出现了大量 I/O 操作，也有可能是内核崩溃或是硬件问题。如果内核仍然在运行，可以尝试使用 SysRq 快捷键做一些操作。如果机器没有 SysRq 按键（例如笔记本电脑），可以使用 PrintScreen 键代替。</p>
<p>根据发行版配置的不同，默认情况下仅允许有限的 SysRq 操作，可以向 <code>/proc/sys/kernel/sysrq</code> 写入 1 来运行全部操作，或者自行计算允许的操作，详情见 <a href="https://docs.kernel.org/admin-guide/sysrq.html#how-do-i-enable-the-magic-sysrq-key">Linux 内核文档的「Linux Magic System Request Key Hacks」部分</a>。需要在 sysctl 配置中设置 <code>kernel.sysrq=1</code> 以持久化相应设置。</p>
<p>最常见的 SysRq 系列指令为 REISUB（即 busy 的比较级 busier 反过来），即按顺序按下 Alt+SysRq+R、E、I、S、U、B，分别对应的操作为：</p>
<ul>
<li>(un)R(aw)：修改键盘模式到 ASCII（XLATE），一般用于从 X 桌面环境夺取键盘控制。</li>
<li>t(E)rm：发送 SIGTERM 信号给所有进程。</li>
<li>k(I)ll：发送 SIGKILL 信号给所有进程。</li>
<li>(S)ync：将所有已挂载文件系统的缓冲区数据写入磁盘。</li>
<li>(U)nmount：重新挂载所有文件系统为只读模式。</li>
<li>re(B)oot：重启系统。</li>
</ul>
<p>如果确信问题是由于某些进程占用大量内存导致的，可以使用 Alt+SysRq+F 来触发内核的 OOM Killer。</p>
<p>另外，向 <code>/proc/sysrq-trigger</code> 写入字符也可以触发对应的操作。其他内容可以参考以上内核文档链接。</p>
<div class="admonition lab">
<p class="admonition-title">测试 kdump</p>
<p>Debian 的 <code>kdump-tools</code> 包可以帮助配置在内核崩溃（kernel panic）时自动进入 kdump 的备用内核，以便在硬盘上存储内核的 coredump 等调试信息。尝试在测试环境安装 <code>kdump-tools</code>，并使用 SysRq 触发内核崩溃，验证配置的有效性。</p>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">用户态 OOM Killer</p>
<p>Linux kernel 包含一个 OOM Killer 机制，当内存不足时，OOM Killer 会给程序打分，选择分数最高的进程杀死。但是，在 OOM Killer 介入之前，内核会尽可能尝试通过回收缓存等方式满足内存需求，而如果缓存数据是非常频繁使用的，那么就会频繁出现在回收缓存之后又读取回来的情况，会极大地占用 IO 资源，导致系统变得几乎不可用，但是又由于回收操作确实释放了内存，所以 OOM Killer 不会介入。</p>
<p>用户态 OOM Killer 可以很大程度缓解这个问题，最常用的两个实现如下：</p>
<ul>
<li>
<p>systemd-oomd。在最近的发行版中一般预装。它以 cgroup 为单位，根据内存的 PSI 信息与物理内存和 swap 占用比例判断，如果 PSI 在一段时间内超过设置的阈值，或者物理内存和 swap 的占用比例都超过阈值，就会将对应的 cgroup 杀死。如果使用 oomd，建议开启 swap，以便为 oomd 提供足够的响应时间处理。</p>
<p>由于 oomd 处理以 cgroup 为单位，因此在桌面环境下需要确定桌面环境可以正确将每个应用放在独立的 cgroup 中（GNOME、KDE 等现代桌面环境是没有问题的）；在服务器场景下，如果你有使用 tmux 等工具的习惯，那么可能需要配置让它们的每个窗口都在不同的 cgroup 中（例如配置 tmux 的 <code>default-command</code> 为 <code>systemd-run --user --scope bash</code>），否则在运行了过分占用内存的程序后，oomd 会将整个 tmux cgroup 杀死。</p>
<p>oomd 是 opt-in 的——需要主动在 systemd 相关 unit 中添加相关配置，oomd 才会处理。可以使用 <code>oomctl</code> 命令获取当前 oomd 状态，检查 "Swap Monitored CGroups" 与 "Memory Pressure Monitored CGroups" 是否包含需要监控的 systemd unit。诸如 Debian、Fedora 等发行版均做了相关的预配置。</p>
<p>除了在 unit 文件中配置 <code>ManagedOOMSwap</code> 和 <code>ManagedOOMMemoryPressure</code> 外，建议通过编辑 <code>/etc/systemd/oomd.conf</code> 文件来调整 oomd 的全局行为。其中 <code>SwapUsedLimit</code> 参数（默认为 90%）虽然名称中包含 "Swap"，但它<strong>同时适用于物理内存和 Swap 空间</strong>。oomd 触发的条件是：内存压力（PSI）超过 <code>DefaultMemoryPressureLimit</code> <strong>或</strong> (物理内存使用率 &gt; <code>SwapUsedLimit</code> <strong>且</strong> Swap 空间使用率 &gt; <code>SwapUsedLimit</code>)。当达到 <code>SwapUsedLimit</code> 时，oomd 会杀死占用 swap 最高且占用量超过 5% swap 的 cgroup；当达到 <code>OOMMemoryPressureLimit</code> 时，oomd 会优先选择需要让系统回收最多内存（带来的压力最多）的 cgroup。</p>
<p>在物理内存较大的服务器上，默认的 90% <code>SwapUsedLimit</code> 可能过早触发 OOM Killer，影响正常使用。此时可以考虑将其调整至更高的值，例如 95% 或 98%，根据实际物理内存大小预留一部分即可。另外，可能有一点不符合预期的是，在设置 <code>SwapUsedLimit</code> 的时候，会首先 kill 占用 swap 最多的进程，而不是占用内存最多的进程，因此可能会出现占用了最多的内存的进程并没有被 kill，而是占用比较少内存的进程被 kill 了。</p>
<details class="example">
<summary>Debian 12 中的 systemd-oomd 配置</summary>
<p>Debian 12 的默认配置为：在用户 slice 下，如果内存压力超过 50%，则杀死压力最大的 cgroup；如果全系统 swap 使用率超过默认值（90%），则杀死占用最大的 cgroup。</p>
<div class="highlight"><span class="filename">/usr/lib/systemd/system/-.slice.d/10-oomd-root-slice-defaults.conf</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">[Slice]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="na">ManagedOOMSwap</span><span class="o">=</span><span class="s">kill</span>
</code></pre></div>
<div class="highlight"><span class="filename">/usr/lib/systemd/system/user@.service.d/10-oomd-user-service-defaults.conf</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">[Service]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="na">ManagedOOMMemoryPressure</span><span class="o">=</span><span class="s">kill</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="na">ManagedOOMMemoryPressureLimit</span><span class="o">=</span><span class="s">50%</span>
</code></pre></div>
</details>
<details class="example">
<summary>Fedora 42 中的 systemd-oomd 配置</summary>
<p>Fedora 42 的默认配置为：在系统和用户 slice 下，如果内存压力超过 80%，则杀死压力最大的 cgroup。</p>
<div class="highlight"><span class="filename">/usr/lib/systemd/system/system.slice.d/10-oomd-per-slice-defaults.conf</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">[Slice]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="na">ManagedOOMMemoryPressure</span><span class="o">=</span><span class="s">kill</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="na">ManagedOOMMemoryPressureLimit</span><span class="o">=</span><span class="s">80%</span>
</code></pre></div>
<div class="highlight"><span class="filename">/usr/lib/systemd/user/slice.d/10-oomd-per-slice-defaults.conf</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">[Slice]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="na">ManagedOOMMemoryPressure</span><span class="o">=</span><span class="s">kill</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="na">ManagedOOMMemoryPressureLimit</span><span class="o">=</span><span class="s">80%</span>
</code></pre></div>
</details>
</li>
<li>
<p><a href="https://github.com/rfjakob/earlyoom">earlyoom</a>。earlyoom 使用 <a href="https://man7.org/linux/man-pages/man2/mlock.2.html">mlock(2)</a> 来保证在内存不足时其本身仍然可以响应。它会定时检查内存使用情况，如果内存不足，则杀死内核评估 oom 分数最高的进程。</p>
<p>earlyoom 可以配置在杀死进程后执行命令（例如提示用户有进程被杀死）。Vlab 项目即做了相关的配置，通过结合 zenity 弹出对话框，效果如下：</p>
<p><img alt="earlyoom in Vlab" src="../../images/vlab-earlyoom.png" /></p>
</li>
</ul>
<div class="admonition question">
<p class="admonition-title">tmpfs?</p>
<p>思考这个问题：如果某个在容器中的进程错误地向 tmpfs 写入了大量数据导致内存不足，systemd-oomd 可以解决这个问题吗？earlyoom 呢？</p>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">系统无法启动</p>
<p>系统启动失败可能会有各种各样的原因，因此以下只能够提供对一部分情况有帮助的信息。</p>
<p>如果你无法看到 GRUB 界面，或者确定已经无法从硬盘引导到可以收拾残局的状态，那么建议使用 LiveCD/USB 启动系统（和安装系统的方式类似）进行救援操作。这里建议使用 Arch Linux 的安装镜像（又称为 archiso），因为：</p>
<ul>
<li>内核较新，对较新的硬件支持较好</li>
<li>占用空间小</li>
<li><code>arch-chroot</code> 工具可以方便地 chroot 到安装的系统中，以便执行操作<ul>
<li>如果不使用 <code>arch-chroot</code>，在 chroot 进入系统前就需要手动挂载 <code>/proc</code>、<code>/sys</code>、<code>/dev</code> 等文件系统、配置 <code>/etc/resolv.conf</code> 等等，比较麻烦。</li>
</ul>
</li>
</ul>
<p>如果可以看到 GRUB 界面，但是发现进入系统时卡死且没有详细的错误信息，那么需要在 GRUB 界面中按下 <code>e</code> 键，编辑对应的启动项，删除 <code>linux</code> 这一行的 <code>quiet</code> 和 <code>splash</code> 选项。发行版可能会默认包含这些选项，以减小启动时的输出信息，以及显示漂亮的启动动画（如果有），但是这会影响到问题调试。</p>
<p>诸如 Debian 等发行版会额外生成 recovery 的启动项，会配置进入单用户模式（single user mode），可以尝试使用这个选项进入系统。</p>
</div>
<h2 id="status-and-logs">服务状态与日志<a class="headerlink" href="#status-and-logs" title="Permanent link">&para;</a></h2>
<h3 id="logs-intro">日志简介<a class="headerlink" href="#logs-intro" title="Permanent link">&para;</a></h3>
<p>当出现异常，登录系统后，第一件事情可能是检查当前系统的服务状态。
<code>systemctl --failed</code> 可以列出当前失败的服务。
如果显示大量服务失败，那么说明可能遇到了比较严重的问题，例如磁盘已满等。
可以先尝试将失败的服务恢复。<code>systemctl status</code> 可以列出当前系统中的 cgroup 情况（约等于所有正在运行的服务以及进程的树）。</p>
<p>检查日志内容也是检查、排除问题的重要步骤。
现代基于 systemd 的 Linux 系统的日志通常由 systemd-journald 负责管理。
以下是常用的命令：</p>
<ul>
<li><code>journalctl -b</code>: 查看本次开机的日志。在 <code>-b</code> 后加上 <code>-1</code>/<code>-2</code> 等可以查看上次/上上次等的开机日志。</li>
<li><code>journalctl --since "1 hour ago"</code>: 查看最近一小时的日志。</li>
<li><code>journalctl -u xxx.service</code>: 查看某个服务的日志。</li>
<li><code>journalctl -f</code>: 实时查看日志。</li>
<li><code>journalctl -b -k</code>: 查看本次启动的内核态日志。
  <code>dmesg</code> 的命令虽然也可以查看，但是因为内核内存有限，所以可能看不到较早的内核态日志信息。
  journald 会帮我们持久化内核态日志信息。</li>
</ul>
<p>journalctl 默认会使用 pager（换句话说，<code>less</code>）显示日志，当然也可以后面接个 <code>| grep ...</code> 来过滤日志。
此外，如果使用了用户服务（user service），那么检查用户服务的状态或者日志时，需要加上 <code>--user</code> 参数。</p>
<div class="admonition comment">
<p class="admonition-title">@taoky: journald 的一点吐槽</p>
<p>首先……journald 看日志太慢了，日志很多的话实在是慢。
而且 <code>systemctl status xxx.service</code> 因为要显示最近几条日志，
也跟着慢——在 mirrors 服务器上甚至要一分多钟才能显示出服务状态。
关于这个问题，可以阅读以下讨论:</p>
<ul>
<li><a href="https://github.com/systemd/systemd/issues/2460">https://github.com/systemd/systemd/issues/2460</a></li>
<li><a href="https://github.com/systemd/systemd/pull/29261">https://github.com/systemd/systemd/pull/29261</a></li>
<li><a href="https://github.com/systemd/systemd/pull/30209">https://github.com/systemd/systemd/pull/30209</a></li>
</ul>
<p>然后，journald 设置按照时间的 retention 也不太方便。
比如说，如果想保留 180 天的日志的话，怎么设置 journald 呢？
<code>MaxRetentionSec</code> 似乎不够……</p>
<p>最后一点是，如果要实时看内核态日志，我更推荐用 <code>dmesg -w</code>，因为颜色更好看一些。</p>
</div>
<p>大部分的 Debian 系统会预装 rsyslog，它会将 journald 的日志转发到 <code>/var/log/syslog</code>，可以直接使用常规的命令行文本处理工具分析。
其他一些软件可能也不会使用 journald，而是直接将日志写入到 <code>/var/log/</code> 目录下的文件中，例如 nginx。</p>
<p>logrotate 会定期（一般是每天，或者文件足够大的时候，请参考 <code>/etc/logrotate*</code> 对应的配置）「轮转」（rotate）日志文件：
这是一个将旧日志压缩，更旧的日志删除的过程。为了分析被压缩过的历史日志，可以使用对应压缩软件提供的工具，例如 <code>gz</code> 格式对应 <code>zcat</code>/<code>zgrep</code>，<code>xz</code> 格式对应 <code>xzcat</code>/<code>xzgrep</code>，<code>zst</code> 格式对应 <code>zstdcat</code>/<code>zstdgrep</code> 等等。</p>
<div class="admonition tip">
<p class="admonition-title">某段日志/错误信息是从哪个程序的源代码中的哪里输出的？</p>
<p>在排查问题时，有时候会需要去搞清楚是什么东西在哪里输出了我们看到的错误信息。此时可以考虑使用代码搜索网站，最常见的选择有：</p>
<ul>
<li>GitHub 代码搜索（需要登录），直接在搜索框输入即可。</li>
<li><a href="https://codesearch.debian.net/">Debian Code Search</a>，可以搜索 Debian 系统中所有包的源代码。</li>
</ul>
<p>某些大型程序也有专门的搜索网站，例如 <a href="https://source.chromium.org/chromium">Chromium Code Search</a>。</p>
</div>
<h3 id="kernel-panic-and-pstore">Kernel panic 与 pstore<a class="headerlink" href="#kernel-panic-and-pstore" title="Permanent link">&para;</a></h3>
<p>当内核遇到不可恢复的致命错误时，就会发生「内核恐慌」，即 kernel panic，表示内核崩溃，无法继续操作。
默认情况下，kernel panic 的时候会打印出报错信息，然后需要人工重启。
然而，对于实验室炼丹炉或者不易远程操作的服务器等一些场景来说，管理员可能更希望服务能够尽快恢复，此时可以通过设置 <code>kernel.panic</code> 这一项 sysctl 参数实现在 panic 时的自动重启，但这也使得管理员无法及时地在终端上看到重启前最后的 panic 信息。</p>
<p><strong>pstore</strong>（Persistent Storage）是一个内核特性，用于在系统崩溃时保存报错信息，以供后续分析。
pstore 支持多种存储后端，包括一小段专门划分的内存区域（称为 <a href="https://docs.kernel.org/admin-guide/ramoops.html">ramoops</a>）、ACPI ERST 表以及 UEFI 变量存储区域等。
存储后端通常能够提供至少 64 KiB 的存储空间，足够保存数百行 dmesg（默认保留最后 10 KiB）及其他状态信息。
默认情况下，Linux 会在 <code>/sys/fs/pstore</code> 的位置挂载 pstore 文件系统，管理员可以通过此目录查看 pstore 中存储的日志。
pstore 模块本身的参数也通过 sysfs 暴露，例如可以通过 <code>/sys/module/pstore/parameters/backend</code> 的内容确认当前 pstore 选用的存储后端。</p>
<div class="admonition tip">
<p class="admonition-title">ACPI ERST</p>
<p>可以使用以下命令验证硬件是否支持 ACPI ERST：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>ls<span class="w"> </span>/sys/firmware/acpi/tables/<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ERST
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">UEFI 变量存储可能不会被默认启用</p>
<p>UEFI 变量存储区域的空间是有限的，并且非常不幸的是，UEFI 固件的编写者不少都没有恰当处理<strong>变量存储区域被写满</strong>的情况。这意味着，一旦这种情况发生，那么<strong>系统就可能变砖，无法正常启动</strong>。因此内核提供了 <code>CONFIG_EFI_VARS_PSTORE_DEFAULT_DISABLE</code> 选项，如果它被启用，那么内核就不会默认使用 UEFI 变量存储区域作为 pstore 的存储后端。</p>
<p>视内核与发行版配置，可以使用 <code>zcat /proc/config.gz | grep PSTORE</code> 或 <code>cat /boot/config-$(uname -r) | grep PSTORE</code> 来检查当前内核是否启用了 pstore 以及相关配置情况。</p>
</div>
<div class="admonition note">
<p class="admonition-title">ramoops 能够保留数据吗？</p>
<p>pstore 的 ramoops 后端无法突破物理规律——如果机器断电重启了，那么（易失性）内存里的数据就自然没了。在不断电重启的情况下，内存是否会被清空取决于硬件实现。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">kdump</p>
<p>如果无法使用 pstore，kdump 机制也可以作为替代方案。kdump 需要在启动时占用一块内存空间存储备用内核等信息。在 kernel panic 时，kernel 会 kexec 到备用内核上，备用内核此时就可以获取到内核的 coredump、dmesg 等信息。Debian 可以使用上文提到的 <code>kdump-tools</code> 包来配置 kdump。</p>
</div>
<p>然而，pstore 的容量是有限的，因此 <strong>systemd-pstore</strong> 服务会在启动时自动将 pstore 的内容归档至 <code>/var/lib/systemd/pstore</code>，以便腾出空间，同时保留记录供管理员查阅。
也就是说，如果你在重启后发现 <code>/sys/fs/pstore</code> 是空的，那么你应该去查看 <code>/var/lib/systemd/pstore</code>。</p>
<h2 id="procfs-and-strace">procfs 与 strace<a class="headerlink" href="#procfs-and-strace" title="Permanent link">&para;</a></h2>
<p><code>/proc</code>（procfs）是内核以文件系统形式向用户空间提供的查看、管理进程状态的接口。
其中 <code>/proc/self</code> 指向了访问文件的当前进程的信息，<code>/proc/&lt;pid&gt;</code> 则指向了 PID 对应进程的信息。
常关注的信息（不会直接从 <code>htop</code> 等获得的信息）有：</p>
<ul>
<li><code>cwd</code> 与 <code>exe</code>：程序的当前工作目录与可执行文件路径</li>
<li><code>fd</code> 目录包含了所有程序打开的文件描述符</li>
<li><code>stack</code>：程序在内核态的栈信息，这一项信息在程序一直处于 D 状态（不可中断睡眠）时特别有用</li>
</ul>
<div class="admonition tip">
<p class="admonition-title"><code>lsof</code></p>
<p>lsof 工具可以遍历 procfs 上各个进程的 <code>fd</code> 目录，并输出进程打开的文件信息。以下命令可以快速地输出当前系统全部相关的信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>lsof<span class="w"> </span>-Ki<span class="w"> </span>-n
</code></pre></div>
<p>其中 <code>-Ki</code> 避免 lsof 对线程打开的重复文件计数；而 <code>-n</code> 避免了不必要的 DNS 请求。此外，较新版本 <code>util-linux-extra</code> 包中的 lsfd 工具也有类似的功能。</p>
</div>
<p>在分析进程行为时，另一个相当有用的工具是 <code>strace</code>。它可以输出程序使用的所有系统调用信息，在调试许多问题的时候都可以提供很大的帮助。一些常用的命令有：</p>
<ul>
<li><code>strace ls</code>：跟踪 <code>ls</code> 的系统调用</li>
<li><code>strace -f bash</code>：跟踪 <code>bash</code> 及其 fork 出的子进程的系统调用</li>
<li><code>strace -p &lt;pid&gt;</code>：跟踪指定 PID 的进程的系统调用</li>
<li><code>strace -e openat ls</code>：只跟踪 <code>openat</code> 系统调用</li>
<li><code>strace -ff -o /tmp/test.log bash</code>：将 <code>bash</code> 及其 fork 出的子进程的系统调用输出到 <code>/tmp/test.log.*</code></li>
<li><code>strace -k -yy -e mmap ls</code>: 跟踪 <code>ls</code> 的 <code>mmap</code> 系统调用，并打印出执行此系统调用时的堆栈（<code>-k</code>），同时解码所有文件描述符（<code>-yy</code>）。这样即可追踪到每个被 <code>mmap</code> 的文件在程序的何处被引入。</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Sysinternals' Procmon</p>
<p>Windows 系统上的类似工具是 Sysinternals 的 <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Procmon</a>，可以查看所有进程对文件系统、注册表等的操作。有趣的是，Sysinternals 在多年前也推出了 Procmon 的 <a href="https://github.com/Sysinternals/ProcMon-for-Linux">Linux 版本</a>，使用了 eBPF 技术实现（详见下文）。同样的功能（查看全系统的系统调用情况）也可以使用 <code>perf trace</code> 实现。</p>
</div>
<div class="admonition example">
<p class="admonition-title">案例：CentOS 7 容器使用 <code>yum</code> 安装软件的 bug</p>
<p>在某些配置下，可以注意到 <code>centos:7</code> 容器中使用 <code>yum</code> 安装软件时会卡住：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>centos:7<span class="w"> </span>bash
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="gp">[root@16c7cc5f835d /]# </span>yum<span class="w"> </span>update
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">（略）</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="go">  Updating   : tzdata-2024a-1.el7.noarch                                                                                      1/102 </span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="go">  Updating   : bash-4.2.46-35.el7_9.x86_64                                                                                    2/102 </span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="go">  Updating   : glibc-common-2.17-326.el7_9.x86_64                                                                             3/102 </span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="go">  Updating   : nss-softokn-freebl-3.90.0-6.el7_9.x86_64                                                                       4/102 </span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="go">  Updating   : glibc-2.17-326.el7_9.x86_64                                                                                    5/102</span>
</code></pre></div>
<p>此时发现 <code>/usr/bin/python /usr/bin/yum update</code> CPU 占用 100%。使用 <code>strace</code> 跟踪 <code>yum</code> 的系统调用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>strace<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span><span class="m">3163763</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="go">fcntl(441032195, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="go">fcntl(441032196, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="go">fcntl(441032197, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="go">fcntl(441032198, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="go">fcntl(441032199, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">fcntl(441032200, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="go">fcntl(441032201, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="go">fcntl(441032202, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="go">fcntl(441032203, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="go">fcntl(441032204, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="go">fcntl(441032205, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="go">fcntl(441032206, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="go">fcntl(441032207, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="go">fcntl(441032208, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="go">fcntl(441032209, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="go">fcntl(441032210, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="go">fcntl(441032211, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="go">fcntl(441032212, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="go">fcntl(441032213, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="go">fcntl(441032214, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="go">fcntl(441032215, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="go">fcntl(441032216, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="go">fcntl(441032217, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="go">fcntl(441032218, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="go">fcntl(441032219, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="go">fcntl(441032220, F_GETFD)               = -1 EBADF (Bad file descriptor)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="go">...</span>
</code></pre></div>
<p>可以发现其在遍历所有可能的文件描述符，但是在该容器环境中，这个范围过大，导致了 <code>yum</code> 卡住。
搜索后可以发现这是个已知的 bug：如果容器没有限制文件描述符的范围，那么默认值就特别大：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="gp">[root@16c7cc5f835d /]# </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="go">1073741816</span>
</code></pre></div>
<p>而某些程序无法正确处理这种情况（默认文件描述符范围不大，然后一个一个去尝试操作）。
不仅是 <code>yum</code>，诸如 <code>xinetd</code> 等也有类似的问题（<a href="https://github.com/USTC-Hackergame/hackergame-challenge-docker/pull/4">ref</a>）。</p>
</div>
<p>strace 的输出格式并不总是最可读的形式，所以，还有一些专注于特定领域的系统调用追踪工具，比如：</p>
<ul>
<li><a href="https://github.com/kxxt/tracexec">tracexec</a> 专注于追踪 exec 系列的系统调用，能够重新构造执行的程序的 shell 命令行并显示环境变量和文件描述符相较于原始环境的差异。除此之外，在用 gdb 调试程序时可能遇到比较复杂的场景，比如被调试的程序是被一个 python 脚本启动的，或者两个需要被调试的程序之间需要通过管道通信（<code>a | b</code>），<a href="https://github.com/kxxt/tracexec/tree/main/demonstration/gdb-launcher">这时可以通过 tracexec 方便地在 <code>execve{,at}</code> 系统调用结束时，程序开始执行前将 gdb 调试器接入想要调试的所有程序</a>。</li>
</ul>
<p>除 strace 以外，Linux 中还有很多用于监控、追踪系统状态的工具，如图所示：</p>
<p><img alt="Linux tools" src="https://www.brendangregg.com/Perf/linux_observability_tools.png" /></p>
<p>需要根据具体情况选择合适的工具。本文亦无法详细介绍每一个工具的使用方法，因此请参考对应工具的手册。</p>
<h2 id="debug-symbols-and-gdb">调试符号与 gdb<a class="headerlink" href="#debug-symbols-and-gdb" title="Permanent link">&para;</a></h2>
<p>有的时候，我们会遇到程序崩溃的情况。除了程序本身留下的日志以外，另一个重要的信息就是程序的 coredump。
coredump 中包含了程序的内存信息，通过解析 coredump，我们可以获取在程序崩溃时详细的调用栈信息，这对于排查问题非常有帮助。</p>
<p>在安装了 systemd-coredump 的系统上，其会自动收集程序崩溃时的 coredump；
对于正在运行的程序，也可以使用 <code>gcore</code> 命令来生成 coredump。
但是 coredump 还需要配合<strong>调试符号</strong>才能进行分析，否则得到的内容包括写程序的人自己都不可能看懂。
对于 Debian，可以参考 <a href="https://wiki.debian.org/HowToGetABacktrace">https://wiki.debian.org/HowToGetABacktrace</a> 来获取调试符号，其他的发行版则需要阅读发行版对应的手册。
一般来讲，许多发行版目前都提供了从 debuginfod 自动获取调试符号的功能，也可以选择手动安装调试符号包。</p>
<p>有了调试符号之后，就可以使用 <code>gdb</code> 分析 coredump 了。对于 systemd-coredump，使用如下命令：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="gp">$ </span>coredumpctl<span class="w"> </span>list
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">（找到对应的 coredump 以及其 pid）</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="gp">$ </span>coredumpctl<span class="w"> </span>gdb<span class="w"> </span>&lt;pid&gt;<span class="w">  </span><span class="c1"># 如果是最近一次的 coredump，可以省略 &lt;pid&gt;</span>
</code></pre></div>
<p>如果是 coredump 文件的形式，也可以直接调用 gdb：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">gdb -c core.123456 # 假设 coredump 文件名为 core.123456</span>
</code></pre></div>
<p>如果希望运行时调试，或者直接使用 gdb 启动希望调试的程序：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="gp">$ </span>gdb<span class="w"> </span>-p<span class="w"> </span>&lt;pid&gt;<span class="w">  </span><span class="c1"># 附加（attach）到指定的 pid 调试</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="gp">$ </span>gdb<span class="w"> </span>/path/to/program<span class="w">  </span><span class="c1"># 直接启动 gdb 并调试指定的程序</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="gp">$ </span>gdb<span class="w"> </span>--args<span class="w"> </span>/path/to/program<span class="w"> </span>arg1<span class="w"> </span>arg2<span class="w">  </span><span class="c1"># 启动 gdb 并调试指定的程序，同时传入参数</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="gp">$ </span>gdb<span class="w"> </span>--args<span class="w"> </span>env<span class="w"> </span><span class="nv">VAR</span><span class="o">=</span>VALUE<span class="w"> </span>/path/to/program<span class="w"> </span>arg1<span class="w"> </span>arg2<span class="w">  </span><span class="c1"># 启动 gdb 并调试指定的程序，同时传入环境变量和参数</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go">GNU gdb (GDB) 14.2</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="go">Copyright (C) 2023 Free Software Foundation, Inc.</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="go">...</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="go">&gt;&gt;&gt; run  # 启动程序，在启动程序前，可以进行断点设置等操作</span>
</code></pre></div>
<p>在进入调试环境后，使用 <code>bt</code> 命令可以查看当前线程的调用栈。在调试符号配置正确的情况下，至少大部分的信息都能被显示出来（而不是一堆 <code>???</code>）。</p>
<details class="example">
<summary>一个 coredump 的调用栈例子</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="go">&gt;&gt;&gt; bt</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="gp">#</span><span class="m">0</span><span class="w">  </span>g_type_check_instance_cast
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">    (type_instance=type_instance@entry=0x60166e80e040, iface_type=0x60166aa86e20 [GtkWidget/GInitiallyUnowned])</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="go">    at ../glib/gobject/gtype.c:4217</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="gp">#</span><span class="m">1</span><span class="w">  </span>0x00007408aee7a370<span class="w"> </span><span class="k">in</span><span class="w"> </span>registry_handle_global
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="go">    (data=0x60166e80e040, registry=&lt;optimized out&gt;, name=81, interface=0x60166f7c7840 &quot;wl_output&quot;, version=&lt;optimized out&gt;)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="go">    at ../spice-gtk-0.42/src/wayland-extensions.c:77</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="gp">#</span><span class="m">2</span><span class="w">  </span>0x00007408ca373596<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="gp">#</span><span class="m">3</span><span class="w">  </span>0x00007408ca37000e<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="gp">#</span><span class="m">4</span><span class="w">  </span>0x00007408ca372bd3<span class="w"> </span><span class="k">in</span><span class="w"> </span>ffi_call<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="gp">#</span><span class="m">5</span><span class="w">  </span>0x00007408c327f645<span class="w"> </span><span class="k">in</span><span class="w"> </span>wl_closure_invoke<span class="w"> </span><span class="o">(</span><span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x60166f7c7760,<span class="w"> </span><span class="nv">target</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="go">    target@entry=0x60166ead1ff0, opcode=opcode@entry=0, data=&lt;optimized out&gt;, flags=1) at ../wayland-1.22.0/src/connection.c:1025</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="gp">#</span><span class="m">6</span><span class="w">  </span>0x00007408c327fe73<span class="w"> </span><span class="k">in</span><span class="w"> </span>dispatch_event<span class="w"> </span><span class="o">(</span><span class="nv">display</span><span class="o">=</span>display@entry<span class="o">=</span>0x60166a9ffed0,<span class="w"> </span><span class="nv">queue</span><span class="o">=</span>0x60166a9fffc0<span class="o">)</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="go">    at ../wayland-1.22.0/src/wayland-client.c:1631</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="gp">#</span><span class="m">7</span><span class="w">  </span>0x00007408c328013c<span class="w"> </span><span class="k">in</span><span class="w"> </span>dispatch_queue<span class="w"> </span><span class="o">(</span><span class="nv">queue</span><span class="o">=</span>0x60166a9fffc0,<span class="w"> </span><span class="nv">display</span><span class="o">=</span>0x60166a9ffed0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../wayland-1.22.0/src/wayland-client.c:1777
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="gp">#</span><span class="m">8</span><span class="w">  </span>wl_display_dispatch_queue_pending<span class="w"> </span><span class="o">(</span><span class="nv">display</span><span class="o">=</span>0x60166a9ffed0,<span class="w"> </span><span class="nv">queue</span><span class="o">=</span>0x60166a9fffc0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../wayland-1.22.0/src/wayland-client.c:2019
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="gp">#</span><span class="m">9</span><span class="w">  </span>0x00007408c3478a39<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libgdk-3.so.0
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="gp">#</span><span class="m">10</span><span class="w"> </span>0x00007408c3444fa9<span class="w"> </span><span class="k">in</span><span class="w"> </span>gdk_display_get_event<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libgdk-3.so.0
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="gp">#</span><span class="m">11</span><span class="w"> </span>0x00007408c3480208<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libgdk-3.so.0
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="gp">#</span><span class="m">12</span><span class="w"> </span>0x00007408c8ee8f69<span class="w"> </span><span class="k">in</span><span class="w"> </span>g_main_dispatch<span class="w"> </span><span class="o">(</span><span class="nv">context</span><span class="o">=</span>0x60166aa114b0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../glib/glib/gmain.c:3476
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="gp">#</span><span class="m">13</span><span class="w"> </span>0x00007408c8f473a7<span class="w"> </span><span class="k">in</span><span class="w"> </span>g_main_context_dispatch_unlocked<span class="w"> </span><span class="o">(</span><span class="nv">context</span><span class="o">=</span>0x60166aa114b0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../glib/glib/gmain.c:4284
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="gp">#</span><span class="m">14</span><span class="w"> </span>g_main_context_iterate_unlocked.isra.0
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="go">    (context=context@entry=0x60166aa114b0, block=block@entry=1, dispatch=dispatch@entry=1, self=&lt;optimized out&gt;)</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="go">    at ../glib/glib/gmain.c:4349</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="gp">#</span><span class="m">15</span><span class="w"> </span>0x00007408c8ee7162<span class="w"> </span><span class="k">in</span><span class="w"> </span>g_main_context_iteration<span class="w"> </span><span class="o">(</span><span class="nv">context</span><span class="o">=</span>context@entry<span class="o">=</span>0x60166aa114b0,<span class="w"> </span><span class="nv">may_block</span><span class="o">=</span>may_block@entry<span class="o">=</span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="go">    at ../glib/glib/gmain.c:4414</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="gp">#</span><span class="m">16</span><span class="w"> </span>0x00007408c8c95b66<span class="w"> </span><span class="k">in</span><span class="w"> </span>g_application_run<span class="w"> </span><span class="o">(</span><span class="nv">application</span><span class="o">=</span>0x60166abe9ce0<span class="w"> </span><span class="o">[</span>GtkApplication<span class="o">]</span>,<span class="w"> </span><span class="nv">argc</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">argv</span><span class="o">=</span>0x0<span class="o">)</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="go">    at ../glib/gio/gapplication.c:2577</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="gp">#</span><span class="m">17</span><span class="w"> </span>0x00007408ca373596<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="gp">#</span><span class="m">18</span><span class="w"> </span>0x00007408ca37000e<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="gp">#</span><span class="m">19</span><span class="w"> </span>0x00007408ca372bd3<span class="w"> </span><span class="k">in</span><span class="w"> </span>ffi_call<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/libffi.so.8
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="gp">#</span><span class="m">20</span><span class="w"> </span>0x00007408c90566d1<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/python3.11/site-packages/gi/_gi.cpython-311-x86_64-linux-gnu.so
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="gp">#</span><span class="m">21</span><span class="w"> </span>0x00007408c9055090<span class="w"> </span><span class="k">in</span><span class="w"> </span>???<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>/usr/lib/python3.11/site-packages/gi/_gi.cpython-311-x86_64-linux-gnu.so
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="gp">#</span><span class="m">22</span><span class="w"> </span>0x00007408c9f98366<span class="w"> </span><span class="k">in</span><span class="w"> </span>_PyObject_Call
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="go">    (kwargs=&lt;optimized out&gt;, args=0x7408bb5b3140, callable=0x7408c4561470, tstate=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;)</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="go">    at Objects/call.c:343</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a><span class="gp">#</span><span class="m">23</span><span class="w"> </span>PyObject_Call<span class="w"> </span><span class="o">(</span><span class="nv">callable</span><span class="o">=</span>0x7408c4561470,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>0x7408bb5b3140,<span class="w"> </span><span class="nv">kwargs</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Objects/call.c:355
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="gp">#</span><span class="m">24</span><span class="w"> </span>0x00007408c9f6a64d<span class="w"> </span><span class="k">in</span><span class="w"> </span>do_call_core
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="go">    (use_tracing=&lt;optimized out&gt;, kwdict=0x7408bb575d80, callargs=0x7408bb5b3140, func=0x7408c4561470, tstate=&lt;optimized out&gt;)</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="go">    at Python/ceval.c:7349</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="gp">#</span><span class="m">25</span><span class="w"> </span>_PyEval_EvalFrameDefault<span class="w"> </span><span class="o">(</span><span class="nv">tstate</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">frame</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">throwflag</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/ceval.c:5376
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="gp">#</span><span class="m">26</span><span class="w"> </span>0x00007408ca01fae4<span class="w"> </span><span class="k">in</span><span class="w"> </span>_PyEval_EvalFrame<span class="w"> </span><span class="o">(</span><span class="nv">throwflag</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">frame</span><span class="o">=</span>0x7408ca403020,<span class="w"> </span><span class="nv">tstate</span><span class="o">=</span>0x7408ca30d6d8<span class="w"> </span>&lt;_PyRuntime+166328&gt;<span class="o">)</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="go">    at ./Include/internal/pycore_ceval.h:73</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="gp">#</span><span class="m">27</span><span class="w"> </span>_PyEval_Vector
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a><span class="go">    (tstate=tstate@entry=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;, func=func@entry=0x7408c9b06020, locals=locals@entry=0x7408c9b26c80, args=args@entry=0x0, argcount=argcount@entry=0, kwnames=kwnames@entry=0x0) at Python/ceval.c:6434</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="gp">#</span><span class="m">28</span><span class="w"> </span>0x00007408ca01f4cc<span class="w"> </span><span class="k">in</span><span class="w"> </span>PyEval_EvalCode<span class="w"> </span><span class="o">(</span><span class="nv">co</span><span class="o">=</span>0x7408c9af8620,<span class="w"> </span><span class="nv">globals</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">locals</span><span class="o">=</span>0x7408c9b26c80<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/ceval.c:1148
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a><span class="gp">#</span><span class="m">29</span><span class="w"> </span>0x00007408ca03cd03<span class="w"> </span><span class="k">in</span><span class="w"> </span>run_eval_code_obj
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a><span class="go">    (tstate=tstate@entry=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;, co=co@entry=0x7408c9af8620, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80) at Python/pythonrun.c:1741</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="gp">#</span><span class="m">30</span><span class="w"> </span>0x00007408ca038e0a<span class="w"> </span><span class="k">in</span><span class="w"> </span>run_mod
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="go">    (mod=mod@entry=0x60166a2cd578, filename=filename@entry=0x7408c9ad4580, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80, flags=flags@entry=0x7ffd781984f8, arena=arena@entry=0x7408c9a4f7b0) at Python/pythonrun.c:1762</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="gp">#</span><span class="m">31</span><span class="w"> </span>0x00007408ca04f383<span class="w"> </span><span class="k">in</span><span class="w"> </span>pyrun_file
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a><span class="go">    (fp=fp@entry=0x60166a23d470, filename=filename@entry=0x7408c9ad4580, start=start@entry=257, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80, closeit=closeit@entry=1, flags=0x7ffd781984f8) at Python/pythonrun.c:1657</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a><span class="gp">#</span><span class="m">32</span><span class="w"> </span>0x00007408ca04ecf5<span class="w"> </span><span class="k">in</span><span class="w"> </span>_PyRun_SimpleFileObject<span class="w"> </span><span class="o">(</span><span class="nv">fp</span><span class="o">=</span>0x60166a23d470,<span class="w"> </span><span class="nv">filename</span><span class="o">=</span>0x7408c9ad4580,<span class="w"> </span><span class="nv">closeit</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">flags</span><span class="o">=</span>0x7ffd781984f8<span class="o">)</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="go">    at Python/pythonrun.c:440</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="gp">#</span><span class="m">33</span><span class="w"> </span>0x00007408ca04d5f8<span class="w"> </span><span class="k">in</span><span class="w"> </span>_PyRun_AnyFileObject<span class="w"> </span><span class="o">(</span><span class="nv">fp</span><span class="o">=</span>0x60166a23d470,<span class="w"> </span><span class="nv">filename</span><span class="o">=</span>0x7408c9ad4580,<span class="w"> </span><span class="nv">closeit</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">flags</span><span class="o">=</span>0x7ffd781984f8<span class="o">)</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="go">    at Python/pythonrun.c:79</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a><span class="gp">#</span><span class="m">34</span><span class="w"> </span>0x00007408ca048098<span class="w"> </span><span class="k">in</span><span class="w"> </span>pymain_run_file_obj<span class="w"> </span><span class="o">(</span><span class="nv">skip_source_first_line</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">filename</span><span class="o">=</span>0x7408c9ad4580,<span class="w"> </span><span class="nv">program_name</span><span class="o">=</span>0x7408c9b26ef0<span class="o">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a><span class="go">    at Modules/main.c:360</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a><span class="gp">#</span><span class="m">35</span><span class="w"> </span>pymain_run_file<span class="w"> </span><span class="o">(</span><span class="nv">config</span><span class="o">=</span>0x7408ca2f3720<span class="w"> </span>&lt;_PyRuntime+59904&gt;<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Modules/main.c:379
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a><span class="gp">#</span><span class="m">36</span><span class="w"> </span>pymain_run_python<span class="w"> </span><span class="o">(</span><span class="nv">exitcode</span><span class="o">=</span>0x7ffd781984f0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Modules/main.c:601
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a><span class="gp">#</span><span class="m">37</span><span class="w"> </span>Py_RunMain<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>Modules/main.c:680
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a><span class="gp">#</span><span class="m">38</span><span class="w"> </span>0x00007408ca0131eb<span class="w"> </span><span class="k">in</span><span class="w"> </span>Py_BytesMain<span class="w"> </span><span class="o">(</span><span class="nv">argc</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">argv</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Modules/main.c:734
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a><span class="gp">#</span><span class="m">39</span><span class="w"> </span>0x00007408c9c43cd0<span class="w"> </span><span class="k">in</span><span class="w"> </span>__libc_start_call_main
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a><span class="go">    (main=main@entry=0x601669c16120 &lt;main&gt;, argc=argc@entry=2, argv=argv@entry=0x7ffd78198748)</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a><span class="go">    at ../sysdeps/nptl/libc_start_call_main.h:58</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="gp">#</span><span class="m">40</span><span class="w"> </span>0x00007408c9c43d8a<span class="w"> </span><span class="k">in</span><span class="w"> </span>__libc_start_main_impl
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="go">    (main=0x601669c16120 &lt;main&gt;, argc=2, argv=0x7ffd78198748, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7ffd78198738) at ../csu/libc-start.c:360</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="gp">#</span><span class="m">41</span><span class="w"> </span>0x0000601669c16045<span class="w"> </span><span class="k">in</span><span class="w"> </span>_start<span class="w"> </span><span class="o">()</span>
</code></pre></div>
</details>
<p>此外，<code>bt full</code> 可以显示当前线程完整的调用栈，<code>thread apply all bt full</code> 可以显示所有线程的完整调用栈。这些信息在汇报 bug 时会非常有用。</p>
<p>如果需要自行尝试从 coredump 获取信息，以下的命令也会有帮助：</p>
<ul>
<li><code>up</code>/<code>down</code>：切换到上一层/下一层调用栈</li>
<li><code>info args</code> 与 <code>info locals</code>：显示当前函数的参数与局部变量。由于编译器优化，一部分变量会变成 <code>&lt;optimized out&gt;</code>，这些信息会丢失</li>
<li><code>l</code>：显示当前函数的源码</li>
<li><code>print xxx</code>：打印变量的值，参数支持表达式（需要对 C 的指针与类型系统有一定的了解）</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Debian/Ubuntu 的调试符号不包含源代码文件</p>
<p>在安装调试符号后，如果你尝试在 gdb 中使用 <code>l</code> 命令查看源码，可能会发现无法显示。以下以 coreutils 的 <code>yes</code> 程序为例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">b main</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="go">Breakpoint 1 at 0x2330: file src/yes.c, line 62.</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">r</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="go">Starting program: /usr/bin/yes </span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="go">[Thread debugging using libthread_db enabled]</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="go">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="go">Breakpoint 1, main (argc=1, argv=0x7fffffffe018) at src/yes.c:62</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="go">62  src/yes.c: No such file or directory.</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">l</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="go">57  in src/yes.c</span>
</code></pre></div>
<p>此时需要使用 <code>apt source</code> 下载对应的源代码（相关信息可参考<a href="../package/#apt-source">包管理系统</a>相关部分）。<code>apt source</code> 会自动应用 Debian 相关补丁。然后在 gdb 中使用 <code>dir</code> 命令添加源代码目录：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">dir /path/to/coreutils-9.1/</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">Source directories searched: /path/to/coreutils-9.1:$cdir:$cwd</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">l</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="go">57  </span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="go">58  int</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="go">59  main (int argc, char **argv)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="go">60  {</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="go">61    initialize_main (&amp;argc, &amp;argv);</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="go">62    set_program_name (argv[0]);</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="go">63    setlocale (LC_ALL, &quot;&quot;);</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="go">64    bindtextdomain (PACKAGE, LOCALEDIR);</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="go">65    textdomain (PACKAGE);</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="go">66</span>
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">了解内核 backtrace 对应源代码文件与行号</p>
<p>在调试与内核有关的问题时，经常需要判断内核输出的 backtrace 信息里每个函数的具体位置。例如以下是由 SysRq 的 <code>l</code> 命令触发的向 dmesg 输出所有活跃核心当前栈的信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="m">[  243.860496] </span><span class="k">sysrq:</span> Show backtrace of all active CPUs
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="m">[  243.860505] </span>NMI backtrace for cpu 0
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="m">[  243.860507] </span><span class="k">CPU:</span> 0 UID: 0 PID: 3660 Comm: tee Tainted: P           OE      6.12.38+deb13-amd64 #1  Debian 6.12.38-1
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="m">[  243.860510] </span><span class="k">Tainted:</span> [P]=PROPRIETARY_MODULE, [O]=OOT_MODULE, [E]=UNSIGNED_MODULE
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="m">[  243.860511] </span><span class="k">Hardware name:</span> QEMU Standard PC (Q35 + ICH9, 2009), BIOS Arch Linux 1.17.0-1-1 04/01/2014
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="m">[  243.860514] </span><span class="k">Call Trace:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="m">[  243.860525] </span> &lt;TASK&gt;
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="m">[  243.860530] </span> dump_stack_lvl+0x5d/0x80
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="m">[  243.860546] </span> nmi_cpu_backtrace.cold+0x19/0x68
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="m">[  243.860548] </span> ? __pfx_nmi_raise_cpu_backtrace+0x10/0x10
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="m">[  243.860560] </span> nmi_trigger_cpumask_backtrace+0xed/0x100
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="m">[  243.860569] </span> __handle_sysrq.cold+0x9c/0xe6
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="m">[  243.860577] </span> write_sysrq_trigger+0x59/0xb0
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="m">[  243.860590] </span> proc_reg_write+0x57/0xa0
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="m">[  243.860601] </span> vfs_write+0xf5/0x450
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="m">[  243.860612] </span> ksys_write+0x6d/0xf0
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="m">[  243.860614] </span> do_syscall_64+0x82/0x190
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="m">[  243.860616] </span> ? __count_memcg_events+0x53/0xf0
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="m">[  243.860619] </span> ? count_memcg_events.constprop.0+0x1a/0x30
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="m">[  243.860625] </span> ? handle_mm_fault+0x1bb/0x2c0
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="m">[  243.860628] </span> ? do_user_addr_fault+0x36c/0x620
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="m">[  243.860630] </span> ? exc_page_fault+0x7e/0x180
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="m">[  243.860633] </span> entry_SYSCALL_64_after_hwframe+0x76/0x7e
</code></pre></div>
<p>尽管函数名的搜索相对简单，但是怎么定位栈上的某个函数具体运行在哪一行呢？此时可以使用 Linux 内核调试符号（完整的 <code>vmlinux</code>）与 <code>addr2line</code> 工具定位。在 Debian 上需要配置调试符号源后安装当前运行内核对应的 dbg 包。注意内核调试符号很大，需要留出足够空间：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-image-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>-dbg
</code></pre></div>
<p>之后使用 <code>addr2line</code> 即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="gp">$ </span>addr2line<span class="w"> </span>-e<span class="w"> </span>/usr/lib/debug/boot/vmlinux-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span><span class="w"> </span>nmi_trigger_cpumask_backtrace+0xed/0x100
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">debian/build/build_amd64_none_amd64/lib/nmi_backtrace.c:62</span>
</code></pre></div>
<p>可以结合 <code>apt source</code> 获取到的有 Debian 补丁的内核源代码查看。</p>
</div>
<p>需要注意的是，coredump 只包含了崩溃现场的信息，导致崩溃的原因有可能并不在 coredump 中：
例如在之前的执行中，程序已经向错误的位置写入数据，只是没有立刻触发问题。
这就需要考虑使用其他的方法排查问题，例如在运行时使用 <code>valgrind</code> 检查内存访问，或者编译时就添加 AddressSanitizer 等工具。</p>
<p>如果只需要看到程序的调用堆栈，不需要对程序进行调试，也可以使用 <a href="https://github.com/peadar/pstack"><code>pstack</code></a> 或 <code>eu-stack</code>（在 <code>elfutils</code> 包中）等工具。</p>
<h2 id="network-debug">网络问题调试简介<a class="headerlink" href="#network-debug" title="Permanent link">&para;</a></h2>
<p>本节介绍简单的网络问题的调试方法与一些常用的网络问题调试工具。</p>
<h3 id="connectivity-issues">连通性问题<a class="headerlink" href="#connectivity-issues" title="Permanent link">&para;</a></h3>
<h4 id="ping">ping<a class="headerlink" href="#ping" title="Permanent link">&para;</a></h4>
<p>判断是否连接正常最简单的方式是使用 <code>ping</code> 命令。在 Linux 下，<code>ping</code> 会不停向目标地址发送 ICMP Echo Request 包，如果目标地址网络畅通，并且防火墙配置允许响应 Echo Request 的话，就可以收到 Echo Reply 包。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp">$ </span>ping<span class="w"> </span>www.example.com
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">PING www.example.com (2600:1417:4400:24::17d2:7a6) 56 data bytes</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">64 bytes from g2600-1417-4400-0024-0000-0000-17d2-07a6.deploy.static.akamaitechnologies.com (2600:1417:4400:24::17d2:7a6): icmp_seq=1 ttl=50 time=60.2 ms</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">64 bytes from g2600-1417-4400-0024-0000-0000-17d2-07a6.deploy.static.akamaitechnologies.com (2600:1417:4400:24::17d2:7a6): icmp_seq=2 ttl=50 time=60.4 ms</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">^C</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">--- www.example.com ping statistics ---</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="go">rtt min/avg/max/mdev = 60.158/60.300/60.443/0.142 ms</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="gp">$ </span><span class="c1"># 某些情况下需要自行通过 -4 或者 -6 指定使用 IPv4 或者 IPv6</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="gp">$ </span>ping<span class="w"> </span>-4<span class="w"> </span>www.example.com
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="go">PING www.example.com (104.116.243.80) 56(84) bytes of data.</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="go">64 bytes from a104-116-243-80.deploy.static.akamaitechnologies.com (104.116.243.80): icmp_seq=1 ttl=44 time=81.7 ms</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="go">64 bytes from a104-116-243-80.deploy.static.akamaitechnologies.com (104.116.243.80): icmp_seq=2 ttl=44 time=81.9 ms</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="go">^C</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="go">--- www.example.com ping statistics ---</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="go">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="go">rtt min/avg/max/mdev = 81.736/81.799/81.863/0.063 ms</span>
</code></pre></div>
<p><code>ping</code> 的局限性在于，即使 <code>ping</code> 成功，也不代表目标主机的服务正常运行、传输 TCP 或 UDP 包正常；即使 <code>ping</code> 失败，也不代表目标主机的服务不可用。</p>
<h4 id="curl">curl<a class="headerlink" href="#curl" title="Permanent link">&para;</a></h4>
<p>具体的服务一般也有对应的测试工具，例如对 HTTP(S) 类服务可以使用 <code>curl</code> 测试。添加 <code>-v</code> 参数可以查看详细的请求与响应信息，而添加 <code>-I</code> 参数可以发送 HEAD 请求，避免终端输出过多的内容。与 <code>ping</code> 类似，<code>-4</code> 与 <code>-6</code> 参数可以指定使用 IPv4 或者 IPv6。</p>
<details class="example">
<summary><code>curl -I -v</code> 样例输出</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp">$ </span>curl<span class="w"> </span>-I<span class="w"> </span>-v<span class="w"> </span>https://www.example.com
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="go">* Host www.example.com:443 was resolved.</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="go">* IPv6: 2600:1417:4400:24::17d2:7b3, 2600:1417:4400:24::17d2:7a6</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="go">* IPv4: 104.116.243.80, 104.116.243.152</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="go">*   Trying [2600:1417:4400:24::17d2:7b3]:443...</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="go">* Connected to www.example.com (2600:1417:4400:24::17d2:7b3) port 443</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="go">* ALPN: curl offers h2,http/1.1</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="go">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="go">*  CAfile: /etc/ssl/certs/ca-certificates.crt</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="go">*  CApath: /etc/ssl/certs</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="go">* TLSv1.3 (IN), TLS handshake, CERT verify (15):</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Finished (20):</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="go">* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="go">* TLSv1.3 (OUT), TLS handshake, Finished (20):</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="go">* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / X25519 / id-ecPublicKey</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="go">* ALPN: server accepted h2</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="go">* Server certificate:</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="go">*  subject: C=US; ST=California; L=Los Angeles; O=Internet Corporation for Assigned Names and Numbers; CN=*.example.com</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="go">*  start date: Jan 15 00:00:00 2025 GMT</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="go">*  expire date: Jan 15 23:59:59 2026 GMT</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="go">*  subjectAltName: host &quot;www.example.com&quot; matched cert&#39;s &quot;*.example.com&quot;</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="go">*  issuer: C=US; O=DigiCert Inc; CN=DigiCert Global G3 TLS ECC SHA384 2020 CA1</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="go">*  SSL certificate verify ok.</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="go">*   Certificate level 0: Public key type EC/prime256v1 (256/128 Bits/secBits), signed using ecdsa-with-SHA384</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="go">*   Certificate level 1: Public key type EC/secp384r1 (384/192 Bits/secBits), signed using ecdsa-with-SHA384</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="go">*   Certificate level 2: Public key type EC/secp384r1 (384/192 Bits/secBits), signed using ecdsa-with-SHA384</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="go">* using HTTP/2</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="go">* [HTTP/2] [1] OPENED stream for https://www.example.com/</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="go">* [HTTP/2] [1] [:method: HEAD]</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="go">* [HTTP/2] [1] [:scheme: https]</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="go">* [HTTP/2] [1] [:authority: www.example.com]</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="go">* [HTTP/2] [1] [:path: /]</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="go">* [HTTP/2] [1] [user-agent: curl/8.5.0]</span>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="go">* [HTTP/2] [1] [accept: */*]</span>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="go">&gt; HEAD / HTTP/2</span>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="go">&gt; Host: www.example.com</span>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="go">&gt; User-Agent: curl/8.5.0</span>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="go">&gt; Accept: */*</span>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="go">&gt;</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a><span class="go">* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):</span>
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a><span class="go">* old SSL session ID is stale, removing</span>
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a><span class="go">&lt; HTTP/2 200</span>
<a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a><span class="go">HTTP/2 200</span>
<a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a><span class="go">&lt; accept-ranges: bytes</span>
<a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a><span class="go">accept-ranges: bytes</span>
<a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a><span class="go">&lt; content-type: text/html</span>
<a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a><span class="go">content-type: text/html</span>
<a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a><span class="go">&lt; etag: &quot;84238dfc8092e5d9c0dac8ef93371a07:1736799080.121134&quot;</span>
<a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a><span class="go">etag: &quot;84238dfc8092e5d9c0dac8ef93371a07:1736799080.121134&quot;</span>
<a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a><span class="go">&lt; last-modified: Mon, 13 Jan 2025 20:11:20 GMT</span>
<a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a><span class="go">last-modified: Mon, 13 Jan 2025 20:11:20 GMT</span>
<a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a><span class="go">&lt; content-length: 1256</span>
<a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a><span class="go">content-length: 1256</span>
<a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a><span class="go">&lt; cache-control: max-age=681</span>
<a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a><span class="go">cache-control: max-age=681</span>
<a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a><span class="go">&lt; date: Wed, 23 Apr 2025 17:06:41 GMT</span>
<a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a><span class="go">date: Wed, 23 Apr 2025 17:06:41 GMT</span>
<a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a><span class="go">&lt; alt-svc: h3=&quot;:443&quot;; ma=93600,h3-29=&quot;:443&quot;; ma=93600,quic=&quot;:443&quot;; ma=93600; v=&quot;43&quot;</span>
<a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a><span class="go">alt-svc: h3=&quot;:443&quot;; ma=93600,h3-29=&quot;:443&quot;; ma=93600,quic=&quot;:443&quot;; ma=93600; v=&quot;43&quot;</span>
<a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>
<a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a><span class="go">&lt;</span>
<a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a><span class="go">* Connection #0 to host www.example.com left intact</span>
</code></pre></div>
</details>
<h4 id="nc">nc<a class="headerlink" href="#nc" title="Permanent link">&para;</a></h4>
<p>对于简单的纯文本协议，可以使用 <code>nc</code>（netcat）命令进行测试，以连接 <code>www.example.com</code> 的 80 端口为例，输入 HTTP 请求行和头，按两下回车（代表 HTTP 请求结束），即可收到响应：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gp">$ </span>nc<span class="w"> </span>www.example.com<span class="w"> </span><span class="m">80</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">GET / HTTP/1.0</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">Host: www.example.com</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="go">（响应内容）</span>
</code></pre></div>
<p>即使是非纯文本协议，<code>nc</code> 也可用于探测端口是否开放，以 22（SSH）端口为例：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gp">$ </span>nc<span class="w"> </span>&lt;地址&gt;<span class="w"> </span><span class="m">22</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="go">SSH-2.0-OpenSSH_9.2p1 Debian-2+deb12u5</span>
</code></pre></div>
<h4 id="mtr">mtr<a class="headerlink" href="#mtr" title="Permanent link">&para;</a></h4>
<p>对于特定的主机无法连接的问题，我们很多时候会希望知道自己的包在哪一跳丢失了。<code>mtr</code> 命令可以看作是 <code>ping</code> 和 <code>traceroute</code> 的结合体，既可以显示每一跳的延迟，也可以显示丢包率。</p>
<div class="admonition tip">
<p class="admonition-title">mtr-tiny</p>
<p>Debian 下的 <code>mtr</code> 包会包含图形界面程序，在服务器上建议安装 <code>mtr-tiny</code> 包。</p>
</div>
<p>直接使用 <code>mtr &lt;地址&gt;</code> 即可进入交互式界面查看每一跳的情况。如果需要分享给其他人，可以考虑使用 <code>--report</code>（<code>-r</code>）参数进入非交互式的报告模式，使用 <code>-c</code> 设置轮数，类似如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>mtr<span class="w"> </span>-c<span class="w"> </span><span class="m">10</span><span class="w"> </span>-r<span class="w"> </span>www.example.com
</code></pre></div>
<p><code>mtr</code> 默认使用 ICMP Echo 包执行 trace 操作，可以使用 <code>--tcp</code> 和 <code>--udp</code> 参数切换为 TCP 或 UDP 包，此时使用 <code>--port</code> 参数可以指定访问的 TCP/UDP 端口号。</p>
<h4 id="dig">dig 与 DNS<a class="headerlink" href="#dig" title="Permanent link">&para;</a></h4>
<p>如果在进行网络操作时看到类似下面的错误：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="gp">$ </span>curl<span class="w"> </span>-I<span class="w"> </span>www.example.com
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="go">curl: (6) Could not resolve host: www.example.com</span>
</code></pre></div>
<p>那么就需要排查 DNS 的问题。<code>dig</code> 工具可以测试向指定 DNS 服务器的解析情况，一些常见的例子包含：</p>
<ul>
<li><code>dig www.example.com</code>：使用系统默认的 DNS 服务器解析 A 记录</li>
<li><code>dig www.example.com @8.8.8.8</code>：使用 Google 的 DNS 服务器解析 A 记录</li>
<li><code>dig www.example.com AAAA</code>：解析 AAAA（IPv6）记录</li>
<li><code>dig www.example.com +short</code>：直接输出解析结果，不显示其他内容</li>
</ul>
<p>这里系统默认的 DNS 服务器指 <code>/etc/resolv.conf</code> 中的配置的 <code>nameserver</code>，在一部分系统上，<code>nameserver</code> 会是 127.0.0.53，代表其启用了 <code>systemd-resolved</code> 作为本地的 DNS 服务器，此时需要使用 <code>resolvectl</code> 命令查看实际的 DNS 配置。</p>
<div class="admonition tip">
<p class="admonition-title">C 运行时库与 DNS 解析</p>
<p>许多程序会直接使用系统 C 运行时库的 <a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html"><code>getaddrinfo()</code></a> 等函数获取 DNS 解析的结果。但是 <code>dig</code> 不会。这可能导致 <code>dig</code> 运行无误，但是使用 C 运行时库的程序因为其他原因无法正常解析的情况。</p>
<p>可以使用 <code>getent hosts www.example.com</code> 命令来测试 C 运行时库的 DNS 解析情况。</p>
</div>
<h4 id="ip">ip<a class="headerlink" href="#ip" title="Permanent link">&para;</a></h4>
<p><code>ip</code> 命令可以查看本机的网络接口等状态。<code>ip a</code>（<code>ip address</code>）可以查看所有接口的信息，包括 IP 地址、是否上线等：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="gp">$ </span>ip<span class="w"> </span>a
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="go">    inet 127.0.0.1/8 scope host lo</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="go">       valid_lft forever preferred_lft forever</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="go">    inet6 ::1/128 scope host noprefixroute</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="go">       valid_lft forever preferred_lft forever</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="go">2: eth0@if637: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="go">    link/ether be:ed:ab:c0:e6:cf brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="go">    inet 172.31.155.84/16 brd 172.31.255.255 scope global eth0</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="go">       valid_lft forever preferred_lft forever</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="go">    inet6 2001:da8:d800:4bfc:bced:abff:fec0:e6cf/64 scope global dynamic mngtmpaddr noprefixroute</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="go">       valid_lft 86400sec preferred_lft 14400sec</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="go">    inet6 fe80::bced:abff:fec0:e6cf/64 scope link</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="go">       valid_lft forever preferred_lft forever</span>
</code></pre></div>
<p>一般有线网络都以 <code>eth</code> 或者 <code>enp</code> 开头，无线网络以 <code>wlp</code> 开头。如果 <code>state</code> 是 <code>DOWN</code>，那么你可能需要检查一下物理网络情况，例如网线是否有插好等。</p>
<p>如果你有多个网络接口，可以使用 <code>ip r</code>（<code>ip route</code>）命令管理路由表。使用 <code>ip r g &lt;ip&gt;</code>（<code>ip route get</code>）可以确认发送到某个 IP 地址的网络包会经过哪个网络接口：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="gp">$ </span>ip<span class="w"> </span>r<span class="w"> </span>g<span class="w"> </span><span class="m">8</span>.8.8.8
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="go">8.8.8.8 via 172.31.0.1 dev eth0 src 172.31.155.84 uid 1000</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="go">    cache</span>
</code></pre></div>
<h3 id="performance-check">性能检查<a class="headerlink" href="#performance-check" title="Permanent link">&para;</a></h3>
<p>iperf 工具可以用来测试两台主机之间的网络性能。目前 iperf 有两个版本：iperf2 和 iperf3，<strong>两者互不兼容</strong>。关于两者功能的比较，可以参考：</p>
<ul>
<li><a href="https://fasterdata.es.net/performance-testing/network-troubleshooting-tools/throughput-tool-comparision/">Throughput Tool Comparision</a></li>
<li><a href="https://iperf2.sourceforge.io/IperfCompare.html">Iperf 2 &amp; Iperf 3 Comparison Table</a></li>
</ul>
<p>尽管存在功能差异，两者最基础的功能是相似的，都需要先在一台主机上运行 iperf server，再在另一台主机上运行 iperf client 进行测试。默认情况下，iperf 测试的是从 client 上传到 server 的速度，使用 <code>-R</code> 参数可以测试从 server 下载到 client 的速度。以 iperf3 为例：</p>
<ul>
<li>
<p>server 端：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="gp">$ </span>iperf3<span class="w"> </span>-s
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">-----------------------------------------------------------</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="go">Server listening on 5201 (test #1)</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">-----------------------------------------------------------</span>
</code></pre></div>
</li>
<li>
<p>client 端：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="gp">$ </span>iperf3<span class="w"> </span>-c<span class="w"> </span><span class="m">192</span>.168.122.1
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="go">Connecting to host 192.168.122.1, port 5201</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="go">[  5] local 192.168.122.247 port 42522 connected to 192.168.122.1 port 5201</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="go">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="go">[  5]   0.00-1.00   sec  5.60 GBytes  48.1 Gbits/sec    0   2.12 MBytes       </span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="go">[  5]   1.00-2.00   sec  5.95 GBytes  51.1 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="go">[  5]   2.00-3.00   sec  4.96 GBytes  42.6 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="go">[  5]   3.00-4.00   sec  5.37 GBytes  46.1 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="go">[  5]   4.00-5.00   sec  5.74 GBytes  49.3 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="go">[  5]   5.00-6.00   sec  5.55 GBytes  47.7 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="go">[  5]   6.00-7.00   sec  5.72 GBytes  49.1 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="go">[  5]   7.00-8.00   sec  5.65 GBytes  48.6 Gbits/sec    0   2.72 MBytes       </span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="go">[  5]   8.00-9.00   sec  5.72 GBytes  49.1 Gbits/sec    0   2.87 MBytes       </span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="go">[  5]   9.00-10.00  sec  5.25 GBytes  45.1 Gbits/sec    0   3.02 MBytes       </span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="go">- - - - - - - - - - - - - - - - - - - - - - - - -</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="go">[ ID] Interval           Transfer     Bitrate         Retr</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="go">[  5]   0.00-10.00  sec  55.5 GBytes  47.7 Gbits/sec    0             sender</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="go">[  5]   0.00-10.00  sec  55.5 GBytes  47.7 Gbits/sec                  receiver</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="go">iperf Done.</span>
</code></pre></div>
<p>同时 server 端也会显示类似的输出。</p>
</li>
</ul>
<h3 id="network-packet-capture">网络抓包<a class="headerlink" href="#network-packet-capture" title="Permanent link">&para;</a></h3>
<p><code>tcpdump</code> 工具可以用于在服务器上抓包，基础的命令如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># 在 eth0 上抓取所有包，输出到终端</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>tcpdump<span class="w"> </span>-ni<span class="w"> </span>eth0
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1"># 输出到 result.pcap 文件，以便进一步分析</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>tcpdump<span class="w"> </span>-ni<span class="w"> </span>eth0<span class="w"> </span>-w<span class="w"> </span>result.pcap
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># 抓取所有从 8.8.8.8 发送或接收的包</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>tcpdump<span class="w"> </span>-ni<span class="w"> </span>eth0<span class="w"> </span>host<span class="w"> </span><span class="m">8</span>.8.8.8
</code></pre></div>
<p><code>-n</code> 参数用于让 tcpdump 不要去解析主机名，因为解析主机名需要发送额外的 DNS 请求，这在很多情况下都是非预期的，并且会影响抓包性能。例子里面的 <code>host 8.8.8.8</code> 部分为 pcap 表达式，详情可阅读 <a href="https://www.tcpdump.org/manpages/pcap-filter.7.html">pcap-filter(7)</a>。</p>
<div class="admonition question">
<p class="admonition-title">编写 pcap 表达式</p>
<p>尝试编写满足以下要求的表达式，并用 <code>tcpdump</code> 测试：</p>
<ul>
<li>系统发送和接收的所有 DNS（TCP &amp; UDP 53）协议包<ul>
<li>如果只需要 UDP 的包呢？</li>
</ul>
</li>
<li>系统发送到 www.example.com（或其他网站的）的 HTTP 包</li>
<li>系统发送到 80 或 443 接口的所有的包</li>
</ul>
</div>
<p>得到的 pcap 文件可以使用 Wireshark（GUI）或 tshark（TUI）打开分析。Wireshark 过滤表达式的语法与 pcap filter 有所不同。非常常见的包括：</p>
<ul>
<li><code>ip.addr == 8.8.8.8</code>：过滤 IP 为 8.8.8.8 的所有包</li>
<li><code>http</code>：过滤 HTTP 协议</li>
<li><code>tcp.port = 1234</code>：过滤 TCP 端口为 1234 的所有包</li>
</ul>
<div class="admonition question">
<p class="admonition-title">编写 Wireshark 表达式</p>
<p>请在 Wireshark 中编写满足和上一个问题相同的过滤表达式，并测试。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">TLS 抓包</p>
<p>TLS（如 HTTPS 等）是加密的，这意味着抓包只能够看到连接双方之间发送了一些 TLS 数据包（如果是 HTTPS，可能还能看到证书和明文的目标域名，即 SNI），但是无法看到具体的请求与响应内容。但是有些时候，我们需要抓包了解内容，分析问题。</p>
<p>最常用的方法是在启动建立 TLS 连接的程序时添加 <code>SSLKEYLOGFILE</code> 环境变量：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nv">SSLKEYLOGFILE</span><span class="o">=</span>test.log<span class="w"> </span>curl<span class="w"> </span>--http1.1<span class="w"> </span>https://www.example.com
</code></pre></div>
<p>之后在 wireshark 的 TLS 协议设置中设置 (Pre)-Master-Secret log filename 即可，如下图：</p>
<p><img alt="Wireshark setting pre-master-secret log filename" src="../../images/wireshark-tls.png" /></p>
<p><a href="#ebpf">bcc</a> 提供的 <code>sslsniff</code> 工具、<a href="https://github.com/gojue/ecapture">eCapture</a> 工具则通过 eBPF 的方式实现了查看加密内容的功能。</p>
</div>
<div class="admonition note">
<p class="admonition-title">HTTP/HTTPS 抓包工具</p>
<p>如 Burp Suite、Fiddler 等工具专门设计为 HTTP/HTTPS 抓包工具，以方便开发者调试。它们的工作原理是在本机运行一个代理服务器，在设置浏览器或应用使用这个代理服务器后，这些工具就可以获取 HTTP 请求与响应内容。如果安装它们提供的根证书，还可以解密 HTTPS 的内容。</p>
</div>
<h2 id="performance-analysis">性能问题分析<a class="headerlink" href="#performance-analysis" title="Permanent link">&para;</a></h2>
<p>本节介绍使用 <code>perf</code> 等工具进行基础的性能问题分析的方式。<code>perf</code> 工具的源代码随 Linux 内核分发，其也依赖于 Linux 内核头文件。在 Debian 上的包名为 <code>linux-perf</code>。</p>
<p><code>perf</code> 的功能非常丰富，以下仅能介绍一小部分功能。</p>
<h3 id="flamegraph">火焰图<a class="headerlink" href="#flamegraph" title="Permanent link">&para;</a></h3>
<p>火焰图是最常用的用于分析程序性能的图表之一，它可以直观地展示程序中函数的调用关系与耗时。生成的 SVG 文件可以使用浏览器打开并交互。</p>
<p><a href="../../images/flamegraph-example.svg"><img alt="Flamegraph example" src="../../images/flamegraph-example.png" /></a></p>
<p class="caption">火焰图示例。点击图片可以查看完整的 SVG 文件。</p>
<p>火焰图按照函数调用栈的方式竖向展示程序的执行情况，底部是调用栈的最外层，每个条的宽度代表对应的函数执行的 CPU 比例。于是，越宽的条就代表了对应的函数（以及其调用的函数）占用的 CPU 时间越多。可以点击感兴趣的函数来「专注」于这个函数内部的调用栈。</p>
<div class="admonition note">
<p class="admonition-title">为什么要分析「热点」？</p>
<p>阿姆达尔定律（Amdahl's Law）指出，如果某个部分的执行时间占总体的比重大，那么优化这个部分（热点）就能显著提升整体性能；相反，如果某部分所占的时间比例很小，即使优化得再多，对整体性能提升也十分有限。</p>
<p>例如，如果某个程序的 90% 时间都花在了函数 A 上，那么对函数 A 的优化，即使只提升 10% 的性能，也能让整体性能提升 9.9%；但如果函数 B 只占用了 1% 的时间，即使让函数 B 提升了 99% 的性能，整体性能也只能提升不到 1%。</p>
</div>
<p>SVG 火焰图由 <a href="https://github.com/brendangregg/FlameGraph">Brendan Gregg 的 FlameGraph</a> 项目生成，其支持包括 <code>perf</code> 在内的多种性能分析工具的输出。以下以 <code>perf</code> 为例介绍。</p>
<p>首先 clone FlameGraph 仓库，然后使用 <code>perf record</code> 命令对程序采样：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/brendangregg/FlameGraph
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="c1"># 从头执行程序</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>perf<span class="w"> </span>record<span class="w"> </span>-F<span class="w"> </span><span class="m">499</span><span class="w"> </span>--call-graph<span class="w"> </span>dwarf,64000<span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span>stress<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span>-t<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="c1"># 附加到正在运行的程序</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>perf<span class="w"> </span>record<span class="w"> </span>-F<span class="w"> </span><span class="m">499</span><span class="w"> </span>--call-graph<span class="w"> </span>dwarf,64000<span class="w"> </span>-g<span class="w"> </span>-p<span class="w"> </span><span class="m">12345</span>
</code></pre></div>
<p>其中 <code>-F</code> 指定了采样频率为 499 Hz，<code>-g</code> 代表采样函数调用栈，<code>--call-graph</code> 参数指定了调用栈的采样方式。</p>
<div class="admonition note">
<p class="admonition-title">为什么采样频率不使用整百的数字？</p>
<p>以上内容中采样频率设置为了 499 Hz。如果阅读别的教程，可以发现不少也会设置为 99 Hz。避开 500 或者 100 的原因是，某些事件可能会恰好间隔 10ms（100 Hz）或者 2ms（500 Hz）发生，如果采样频率与这些事件的周期刚好匹配，就会导致结果出现偏差。设置为恰好整百减一可以最大程度避免这种情况。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">采样方式</p>
<p><code>perf</code> 支持三种采样方式：</p>
<ul>
<li>
<p><code>fp</code>（默认情况）：根据 frame pointer 寄存器中的信息采样。在函数调用时，frame pointer 会指向当前函数的栈帧（即函数在栈上使用的内存空间，内容包括局部变量、返回地址等）。在 x86_64 架构中，frame pointer 是 RBP 寄存器。</p>
<p>不少编译器会选择优化掉 frame pointer 寄存器，因为其不是程序执行必需的。在 32 位的 x86 架构上，这种优化是非常有必要的，因为 x86 架构的通用寄存器数量非常少，多出一个寄存器可以有效提高程序性能。但是 x86_64 架构的通用寄存器数量提升了不少，因此一般认为这类优化对性能提升不显著，并且会给问题调试与性能调优带来困难。诸如 <a href="https://ubuntu.com/blog/ubuntu-performance-engineering-with-frame-pointers-by-default">Ubuntu</a>、<a href="https://fedoraproject.org/wiki/Changes/fno-omit-frame-pointer">Fedora</a>、<a href="https://gitlab.archlinux.org/archlinux/rfcs/-/merge_requests/26">Arch Linux</a> 等均已经默认开启 frame pointer。</p>
<p>在编译时，可以添加 <code>-fno-omit-frame-pointer</code> 选项来禁用这种优化。</p>
</li>
<li>
<p><code>lbr</code>：使用 Last Branch Record 寄存器来采样，需要 CPU 架构支持。LBR 寄存器会记录最近的分支跳转信息，有权限的程序可以配置让 LBR 寄存器仅记录 <code>call</code> 和 <code>ret</code> 指令，从而实现函数调用栈的采样。虽然不需要程序调整编译参数，但是硬件寄存器的数量是有限的，因此这种方式无法处理过深的函数调用。</p>
</li>
<li><code>dwarf</code>：使用 DWARF 调试信息来采样。这种方式需要程序编译时开启 DWARF 调试信息（<code>gcc -g</code>），开销相对较高。上文中 <code>--call-graph dwarf,64000</code> 的 <code>64000</code> 代表每次采样时记录最多 64000 字节的 stack dump。</li>
</ul>
</div>
<p>采样完成后的数据存储在 <code>perf.data</code> 文件中（可以使用 <code>-o</code> 参数修改）。接下来使用 <code>perf script</code> 输出 trace，并在预处理数据后，使用 FlameGraph 生成火焰图：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>perf<span class="w"> </span>script<span class="w"> </span>&gt;<span class="w"> </span>out.perf
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>FlameGraph/stackcollapse-perf.pl<span class="w"> </span>out.perf<span class="w"> </span>&gt;<span class="w"> </span>out.folded
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>FlameGraph/flamegraph.pl<span class="w"> </span>out.folded<span class="w"> </span>&gt;<span class="w"> </span>out.svg
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title"><code>perf report</code></p>
<p><code>perf.data</code> 文件也可以使用 TUI 的 <code>perf report</code> 命令查看。<code>perf report</code> 的 annotate 功能可以展示函数内部汇编以及对应的代码（如果有调试信息）采样得到的时间占比。</p>
</div>
<p>注意，这种方式不适用于解释型与 JIT 类的语言，因为这一类语言的函数调用栈难以直接通过解释器/运行时的调用栈获取，需要使用各个语言的专用工具处理。</p>
<div class="admonition comment">
<p class="admonition-title">@taoky: 快速生成火焰图</p>
<p>我还是觉得每次都要写这么多命令有点麻烦，所以我自己一般直接用 <a href="https://github.com/flamegraph-rs/flamegraph">flamegraph-rs/flamegraph</a>，于是直接这样就可以生成了：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>flamegraph<span class="w"> </span>-p<span class="w"> </span><span class="m">12345</span>
</code></pre></div>
</div>
<h3 id="hardware-counter">获取硬件计数器统计信息<a class="headerlink" href="#hardware-counter" title="Permanent link">&para;</a></h3>
<p><code>perf stat</code> 命令可以获取硬件计数器的统计信息，帮助了解程序的性能瓶颈：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="gp">$ </span>perf<span class="w"> </span>stat<span class="w"> </span>uname
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="go">Linux</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="go"> Performance counter stats for &#39;uname&#39;:</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="go">              1.34 msec task-clock:u                     #    0.537 CPUs utilized</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="go">                 0      context-switches:u               #    0.000 /sec</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="go">                 0      cpu-migrations:u                 #    0.000 /sec</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="go">                67      page-faults:u                    #   50.119 K/sec</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="go">           228,089      cpu_atom/instructions/u          #    0.75  insn per cycle              (67.70%)</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="go">     &lt;not counted&gt;      cpu_core/instructions/u                                                 (0.00%)</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="go">           305,397      cpu_atom/cycles/u                #    0.228 GHz</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="go">     &lt;not counted&gt;      cpu_core/cycles/u                                                       (0.00%)</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="go">            41,051      cpu_atom/branches/u              #   30.708 M/sec</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="go">     &lt;not counted&gt;      cpu_core/branches/u                                                     (0.00%)</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="go">             3,065      cpu_atom/branch-misses/u         #    7.47% of all branches</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="go">     &lt;not counted&gt;      cpu_core/branch-misses/u                                                (0.00%)</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="go">             TopdownL1 (cpu_atom)                 #     50.3 %  tma_bad_speculation</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="gp">                                                  #     </span><span class="m">16</span>.1<span class="w"> </span>%<span class="w">  </span>tma_retiring
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="go">             TopdownL1 (cpu_atom)                 #      0.0 %  tma_backend_bound</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="gp">                                                  #     </span><span class="m">33</span>.7<span class="w"> </span>%<span class="w">  </span>tma_frontend_bound
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="go">       0.002489347 seconds time elapsed</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="go">       0.000000000 seconds user</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="go">       0.002576000 seconds sys</span>
</code></pre></div>
<p>根据 CPU 架构的不同，<code>perf stat</code> 默认显示的计数器信息也会存在区别。以上命令是在一台运行 Intel 12 代 i5 CPU 的机器上运行的，因此其包含了一些特殊的计数器信息：</p>
<ul>
<li>大小核（core &amp; atom）的计数器信息。</li>
<li><code>tma</code>：Topdown Microarchitecture Analysis，Intel 提供的用于分析 CPU 的性能瓶颈的方法。<ul>
<li>有关使用 <code>perf</code> 利用 TMA 方法分析程序的步骤，可参考 <a href="https://perfwiki.github.io/main/top-down-analysis/">https://perfwiki.github.io/main/top-down-analysis/</a>。</li>
</ul>
</li>
</ul>
<p>用户也可以指定感兴趣的计数器，例如以下命令会显示 CPU 运行程序的时钟周期、命令数、缓存命中与失效信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>$<span class="w"> </span>perf<span class="w"> </span>stat<span class="w"> </span>-e<span class="w"> </span>cycles,instructions,cache-references,cache-misses<span class="w"> </span>stress<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span>-m<span class="w"> </span><span class="m">1</span><span class="w"> </span>-t<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>stress:<span class="w"> </span>info:<span class="w"> </span><span class="o">[</span><span class="m">1968709</span><span class="o">]</span><span class="w"> </span>dispatching<span class="w"> </span>hogs:<span class="w"> </span><span class="m">1</span><span class="w"> </span>cpu,<span class="w"> </span><span class="m">0</span><span class="w"> </span>io,<span class="w"> </span><span class="m">1</span><span class="w"> </span>vm,<span class="w"> </span><span class="m">0</span><span class="w"> </span>hdd
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>stress:<span class="w"> </span>info:<span class="w"> </span><span class="o">[</span><span class="m">1968709</span><span class="o">]</span><span class="w"> </span>successful<span class="w"> </span>run<span class="w"> </span>completed<span class="w"> </span><span class="k">in</span><span class="w"> </span>5s
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w"> </span>Performance<span class="w"> </span>counter<span class="w"> </span>stats<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;stress -c 1 -m 1 -t 5&#39;</span>:
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">     </span><span class="m">5</span>,988,155,941<span class="w">      </span>cpu_atom/cycles/u<span class="w">                                                       </span><span class="o">(</span><span class="m">22</span>.77%<span class="o">)</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">     </span><span class="m">6</span>,878,171,900<span class="w">      </span>cpu_core/cycles/u<span class="w">                                                       </span><span class="o">(</span><span class="m">92</span>.90%<span class="o">)</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">     </span><span class="m">6</span>,948,484,803<span class="w">      </span>cpu_atom/instructions/u<span class="w">          </span><span class="c1">#    1.16  insn per cycle              (22.77%)</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">     </span><span class="m">7</span>,087,148,185<span class="w">      </span>cpu_core/instructions/u<span class="w">          </span><span class="c1">#    1.03  insn per cycle              (92.90%)</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">         </span><span class="m">6</span>,294,530<span class="w">      </span>cpu_atom/cache-references/u<span class="w">                                             </span><span class="o">(</span><span class="m">22</span>.77%<span class="o">)</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">         </span><span class="m">1</span>,730,791<span class="w">      </span>cpu_core/cache-references/u<span class="w">                                             </span><span class="o">(</span><span class="m">92</span>.90%<span class="o">)</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">         </span><span class="m">6</span>,225,141<span class="w">      </span>cpu_atom/cache-misses/u<span class="w">          </span><span class="c1">#   98.90% of all cache refs           (22.77%)</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">         </span><span class="m">1</span>,593,046<span class="w">      </span>cpu_core/cache-misses/u<span class="w">          </span><span class="c1">#   92.04% of all cache refs           (92.90%)</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">       </span><span class="m">5</span>.002407973<span class="w"> </span>seconds<span class="w"> </span><span class="nb">time</span><span class="w"> </span>elapsed
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">       </span><span class="m">5</span>.639733000<span class="w"> </span>seconds<span class="w"> </span>user
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">       </span><span class="m">4</span>.324169000<span class="w"> </span>seconds<span class="w"> </span>sys
</code></pre></div>
<p>可以查看 <a href="https://man7.org/linux/man-pages/man1/perf-stat.1.html">perf-stat(1)</a> 了解如何获取可用的计数器的列表。</p>
<h2 id="ebpf">eBPF<a class="headerlink" href="#ebpf" title="Permanent link">&para;</a></h2>
<p>本部分主要介绍 eBPF 的使用。
在遇到疑难问题时，eBPF 可以帮助我们以非常低的代价在线上系统中获取内核态与应用程序更多的信息。
对于需要获取内核信息的场景，很可能需要阅读内核源码，<a href="https://elixir.bootlin.com/linux/latest/source">elixir.bootlin.com</a>
提供了在浏览器中方便的内核源码阅读功能，支持快速跳转到符号等功能。</p>
<p><a href="https://github.com/iovisor/bcc/">bcc</a> 与 <a href="https://github.com/bpftrace/bpftrace">bpftrace</a>
是两个常用的 eBPF 工具，用户可以用它们编写自己的 eBPF 程序来获取内核态信息。
此外，它们还提供了大量的（示例）工具，对一些常见的问题提供了解决方案，如下面两张图所示
（以下工具的使用请自行查阅资料）：</p>
<p><img alt="Linux bcc/BPF Tracing Tools" src="https://www.brendangregg.com/BPF/bcc_tracing_tools_early2019.png" /></p>
<p><img alt="bpftrace/eBPF Tools" src="https://www.brendangregg.com/BPF/bpftrace_tools_early2019.png" /></p>
<p>考虑到 bpftrace 使用较为简单（不需要写 C 代码），因此以下对 bpftrace 做简单介绍。</p>
<h3 id="kernel-ebpf">内核态<a class="headerlink" href="#kernel-ebpf" title="Permanent link">&para;</a></h3>
<p>bpftrace 中包含了几种内核态的「探针」（probe）：</p>
<ul>
<li>kprobe：默认在函数入口处插入 probe，也可以指定偏移量，从而在函数的任意位置插入 probe</li>
<li>kretprobe：在函数返回时插入 probe，可以获取函数的返回值，不能获取函数的参数</li>
<li>tracepoint：在内核预先定义的 tracepoint 处插入 probe</li>
<li>kfunc/kretfunc：在函数调用/返回时插入 probe，相比于 kprobe/kretprobe，不能在任意位置插入，但是性能更好，并且可以获取到类型信息，kretfunc 也可以获取函数的参数</li>
</ul>
<p>使用 <code>bpftrace -l</code> 可以获取到当前系统支持的所有 probe。一般来说，内核版本越新，支持越好。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-l
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">（省略）</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="go">tracepoint:xhci-hcd:xhci_setup_addressable_virt_device</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="go">tracepoint:xhci-hcd:xhci_setup_device</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="go">tracepoint:xhci-hcd:xhci_setup_device_slot</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="go">tracepoint:xhci-hcd:xhci_stop_device</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="go">tracepoint:xhci-hcd:xhci_urb_dequeue</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="go">tracepoint:xhci-hcd:xhci_urb_enqueue</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="go">tracepoint:xhci-hcd:xhci_urb_giveback</span>
</code></pre></div>
<p>一个简单的例子是获取系统之后执行的所有程序（<a href="https://github.com/bpftrace/bpftrace/blob/master/tools/execsnoop.bt">execsnoop</a>）。
以下是一个简化的版本，输出执行了 <code>execve()</code> 的程序，以及其参数（文件路径）：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;tracepoint:syscalls:sys_enter_execve { printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); }&#39;</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="go">Attaching 1 probe...</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="go">code /home/username/.nix-profile/bin/docker</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="go">code /usr/lib/rustup/bin/docker</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="go">code /home/username/.local/bin/docker</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="go">code /home/username/.cargo/bin/docker</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="go">^C</span>
</code></pre></div>
<p>这里我们可以直接使用 <code>args-&gt;filename</code> 获取到 <code>execve()</code> 的参数，因为 bpftrace 能够获取到相关的类型信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-lv<span class="w"> </span>tracepoint:syscalls:sys_enter_execve
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="go">tracepoint:syscalls:sys_enter_execve</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="go">    int __syscall_nr</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="go">    const char * filename</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="go">    const char *const * argv</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="go">    const char *const * envp</span>
</code></pre></div>
<p>有的时候，你需要追踪的函数不在 tracepoint 中，此时就需要使用 kprobe/kretprobe（或者 kfunc/kretfunc），
例如下面这个追踪 <a href="https://elixir.bootlin.com/linux/v6.8.1/source/mm/memcontrol.c#L2728"><code>try_charge_memcg</code></a> 的第三个参数 <code>nr_pages</code> 的例子：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;kprobe:try_charge_memcg { printf(&quot;%d\n&quot;, arg2); }&#39;</span><span class="w">  </span><span class="c1"># 第一个参数是 arg0</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="go">1</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="go">1</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="go">1</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="go">2</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="go">...</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="go">^C</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="gp">$ </span><span class="c1"># 通常情况下，我们不希望追踪整个系统对某个内核函数的调用，只需要追踪某个进程的调用，因此可以这么写：</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="gp">$ </span><span class="c1"># 假设 PID 为 1234567</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;kprobe:try_charge_memcg /pid == 1234567/ { printf(&quot;%d\n&quot;, arg2); }&#39;</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="go">1</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="go">1</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="go">...</span>
</code></pre></div>
<p>使用 kprobe 和 kretprobe 时，一个常见的 pattern 是：kprobe 记录某种状态（例如时间或者调用参数），然后在 kretprobe 中输出。
相关的例子可以参考 bpftrace 的示例与文档。</p>
<p>在支持 kfunc 的环境下，可以使用 kfunc 让逻辑更加清晰：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-lv<span class="w"> </span>kfunc:try_charge_memcg
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="go">kfunc:vmlinux:try_charge_memcg</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="go">    struct mem_cgroup * memcg</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="go">    gfp_t gfp_mask</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="go">    unsigned int nr_pages</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="go">    int retval</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;kfunc:try_charge_memcg { printf(&quot;%d\n&quot;, args-&gt;nr_pages); }&#39;</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="go">...</span>
</code></pre></div>
<p>除了 bpftrace 这类通用型的调试工具之外，还有很多用来调试特定的问题的调试工具，比如：</p>
<ul>
<li><a href="https://github.com/anakryiko/retsnoop">retsnoop</a> 可以找出内核返回一个错误码的具体位置，方便在错误码含义不够明确的情况下定位更具体的出错原因。</li>
</ul>
<h3 id="user-space-ebpf">用户态<a class="headerlink" href="#user-space-ebpf" title="Permanent link">&para;</a></h3>
<p>eBPF 技术也可以用于用户态调试，在 bpftrace 中对应的是 uprobe 和 uretprobe。</p>
<p>以下面的 C++ 程序为例子：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">example</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="p">}</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="p">}</span>
</code></pre></div>
<p>编译并查看符号：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="gp">$ </span>g++<span class="w"> </span>example.cpp<span class="w"> </span>-O0<span class="w"> </span>-o<span class="w"> </span>example
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="gp">$ </span>nm<span class="w"> </span>example
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="go">0000000000004040 B __bss_start</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="go">                 w __cxa_finalize@GLIBC_2.2.5</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="go">0000000000004028 D __data_start</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="go">0000000000004028 W data_start</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="go">0000000000004030 D __dso_handle</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="go">0000000000003db0 d _DYNAMIC</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="go">0000000000004038 D _edata</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="go">0000000000004158 B _end</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="go">...</span>
</code></pre></div>
<p>我们可以找到 <code>example()</code> 函数对应的符号：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="gp">$ </span>nm<span class="w"> </span>example<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>example
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="go">0000000000001220 T _Z7exampleii</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">符号的名称修饰（Name mangling）</p>
<p>可以注意到，上面的符号名不是 <code>example</code>，而是 <code>_Z7exampleii</code>。
C++ 以及其他某些语言（例如 Rust）会在编译期修改函数的名称，以便支持函数重载等特性。
这里的名字经过 demangle 之后就是 <code>example(int, int)</code>。</p>
</div>
<div class="admonition tip">
<p class="admonition-title"><code>nm</code></p>
<p><code>nm</code> 是一个用于查看二进制文件中符号的工具，可以用于查看函数、变量等的地址。
如果不加参数，那么其会列出文件中的静态符号（例如全局变量、函数等）。
对于动态链接库（<code>.so</code> 文件），可以使用 <code>nm -D</code> 来查看其暴露给应用的动态符号。</p>
</div>
<p>使用 uprobe 追踪 <code>example()</code> 函数的调用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>bpftrace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;uprobe:/path/to/example:_Z7exampleii { printf(&quot;example(%d, %d)\n&quot;, arg0, arg1); }&#39;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="go">Attaching 1 probe...</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="go">（在另一个终端执行 ./example 之后）</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="go">example(0, 1)</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="go">example(1, 2)</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="go">...</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="go">example(1023, 1024)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">编译器优化</p>
<p>如果上面的例子使用 <code>-O2</code>，那么你可能会发现这里的 bpftrace 没有输出任何内容。
这是因为编译器进行了内联优化，将 <code>example()</code> 函数内联到了 <code>main()</code> 函数中，省去了函数调用的开销。
既然没有函数调用，那么也就没有 uprobe 可以追踪的地方。</p>
<p>可以使用 <code>objdump -d</code> 来查看编译后的汇编代码，以确认是否发生了内联优化。</p>
</div>
<div class="admonition lab">
<p class="admonition-title">使用 uprobe 追踪容器中的程序</p>
<p>在容器中编译并运行下面的程序：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;random&gt;</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">example</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="p">}</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="n">gen</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">distr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distr</span><span class="p">(</span><span class="n">gen</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distr</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">example</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="p">}</span>
</code></pre></div>
<p>尝试追踪对应程序的 <code>example()</code> 函数调用。</p>
<p>提示：procfs 中的 <code>/proc/&lt;pid&gt;/root</code> 目录可能会有所帮助。</p>
</div>
<p>更多的例子与说明可以参考：</p>
<ul>
<li><a href="https://github.com/bpftrace/bpftrace/blob/master/docs/tutorial_one_liners.md">The bpftrace One-Liner Tutorial</a>（<a href="https://github.com/bpftrace/bpftrace/blob/master/docs/tutorial_one_liners_chinese.md">中文版</a>）</li>
<li><a href="https://github.com/bpftrace/bpftrace/blob/master/man/adoc/bpftrace.adoc">bpftrace(8) Manual Page</a></li>
</ul>
<div class="admonition lab">
<p class="admonition-title">eBPF 程序编写实验</p>
<p>尝试使用 bpftrace 或 bcc 完成以下任务：</p>
<ul>
<li>对整个系统的程序做监测，当程序退出时，输出程序的运行时间（Wall time）。<ul>
<li>挑战：能否尽可能输出程序被执行时的命令行参数？</li>
</ul>
</li>
<li>对某个程序做监测，当该程序执行某种系统调用时（例如读取文件），输出程序的调用栈。</li>
</ul>
</div>
<h2 id="supplement">补充阅读<a class="headerlink" href="#supplement" title="Permanent link">&para;</a></h2>
<h3 id="supplement-books">书籍<a class="headerlink" href="#supplement-books" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/dendibakh/perf-book/"><em>Performance Analysis and Tuning on Modern CPU</em></a>：非常详细的关于程序性能优化的书籍，同时其练习实验 <a href="https://github.com/dendibakh/perf-ninja">perf-ninja</a> 也值得一看。</li>
<li><a href="https://www.brendangregg.com/systems-performance-2nd-edition-book.html"><em>Systems Performance: Enterprise and the Cloud</em></a>：著名的系统性能分析专家 Brendan Gregg 撰写的关于系统性能分析的书籍，内容涵盖了从硬件到软件的各个方面。</li>
</ul>
<h3 id="supplement-sites">站点<a class="headerlink" href="#supplement-sites" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://bootlin.com/doc/training/debugging/">Linux debugging, profiling and tracing training Course by bootlin</a>：Bootlin 公司提供的 Linux 调试等有关的资料，包括 slides 和练习实验</li>
<li><a href="https://www.brendangregg.com/ebpf.html">Linux Extended BPF (eBPF) Tracing Tools</a>：Brendan Gregg 整理的 eBPF 相关的工具资料；Brendan Gregg 的博客也有很多关于系统性能分析的信息，此外本文的几张工具合集图也出自他手</li>
<li><a href="https://www.brendangregg.com/blog/2024-03-24/linux-crisis-tools.html">Linux Crisis Tools</a>：Brendan Gregg 整理的 Linux 应急响应工具集列表，建议在服务器上预先安装</li>
</ul>
<!--
  Links to man pages

  See <https://squidfunk.github.io/mkdocs-material/reference/tooltips/#adding-a-glossary> for how this file is used.
-->

<!-- markdownlint-disable-file MD041 MD053 -->

<!-- man 1 -->

<!-- man 2 -->

<!-- man 3 -->

<!-- man 4 -->

<!-- man 5 -->

<!-- man 7 -->

<!-- man 8 -->

<!-- Note: Debian man pages for useradd(8)/userdel(8) mentions the "low-level" feature and recommends adduser(8)/deluser(8) instead. 
Do not link to a "generic" man page for these commands -->
<!--
  Links to author URLs (usually GitHub profiles)

  See <https://squidfunk.github.io/mkdocs-material/reference/tooltips/#adding-a-glossary> for how this file is used.
-->

<!-- markdownlint-disable-file MD041 MD053 -->







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年11月9日 19:22:34 UTC">2025年11月9日</span>
  </span>

    
    
    
    
  </aside>


  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Brought to you by <a href="https://lug.ustc.edu.cn/">LUG@USTC</a>. Available under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0 license</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://lug.ustc.edu.cn/" target="_blank" rel="noopener" title="lug.ustc.edu.cn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0M5.78 8.75a9.64 9.64 0 0 0 1.363 4.177q.383.64.857 1.215c.245-.296.551-.705.857-1.215A9.64 9.64 0 0 0 10.22 8.75Zm4.44-1.5a9.64 9.64 0 0 0-1.363-4.177c-.307-.51-.612-.919-.857-1.215a10 10 0 0 0-.857 1.215A9.64 9.64 0 0 0 5.78 7.25Zm-5.944 1.5H1.543a6.51 6.51 0 0 0 4.666 5.5q-.184-.271-.352-.552c-.715-1.192-1.437-2.874-1.581-4.948m-2.733-1.5h2.733c.144-2.074.866-3.756 1.58-4.948q.18-.295.353-.552a6.51 6.51 0 0 0-4.666 5.5m10.181 1.5c-.144 2.074-.866 3.756-1.58 4.948q-.18.296-.353.552a6.51 6.51 0 0 0 4.666-5.5Zm2.733-1.5a6.51 6.51 0 0 0-4.666-5.5q.184.272.353.552c.714 1.192 1.436 2.874 1.58 4.948Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/ustclug" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.01 8.01 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27s-1.36.09-2 .27c-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.footnote.tooltips", "navigation.indexes", "navigation.path", "navigation.sections", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>